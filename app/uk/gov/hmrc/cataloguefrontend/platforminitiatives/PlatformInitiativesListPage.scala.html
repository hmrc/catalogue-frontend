@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.platforminitiatives._
@import uk.gov.hmrc.cataloguefrontend.platforminitiatives.{DisplayType, PlatformInitiative, routes => appRoutes }
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.util.MarkdownLoader
@import play.api.mvc._
@import helper._

@this(viewMessages: ViewMessages)

@(initiatives   : Seq[PlatformInitiative]   ,
    display     : DisplayType               ,
    team        : String                    ,
    teams       : Seq[Team]                 ,
    form        : Form[_]
)(implicit
    messages    : Messages                  ,
    request     : Request[_]
)

@standard_layout(s"Platform Initiatives", "platforminitiatives") {
<header>
    <h1>Platform Initiatives@if(team!=""){: @team}</h1>
    <script type="text/javascript" src="@controllers.routes.Assets.versioned("charts-loader-51.js")"></script>
</header>

@if(form.hasErrors) {
<div class="alert alert-danger" role="alert">
    <ul class="list">
        @form.errors.map { error =>
        <li class="alert-danger"> @Messages(error.message, error.args: _*)</li>
        }
    </ul>
</div>
}

<div id="platform-initiatives">
    <form action="/platform-initiatives" method="get">
        <div class="col-xs-1 padding-reset-right">
            <label for="search">Search:</label>
        </div>
        <div class="col-xs-3">
            <input class="search form-control" id="search" type="text">
        </div>
        <div class="right padding-reset-right" style="line-height:2.2em;">
            @Seq(DisplayType.Chart, DisplayType.Progress).zipWithIndex.map { case (dt, i) =>
                @if(i != 0){ | }
                <a href="@appRoutes.PlatformInitiativesController.platformInitiatives(dt)">
                    @if(display == dt){ <strong>@dt.asString </strong> } else { @dt.asString }
                </a>
            }
            <div style="float:right; margin-top:-1em;">
            @select(field      = form("team")                                                   ,
                    options    = teams
                                    .map(_.name.asString)
                                    .map(t => t -> t)
                                    .distinct
                                    .sorted                                                     ,
                    '_default -> "All"                                                          ,
                    '_label   -> None                                                           ,
                    '_value   -> form("team").value                                             ,
                    '_id      -> "teamName"                                                     ,
                    'onchange -> "this.form.submit();"
                )
            </div>
        </div>
        <br>
        <div class="board">
            <h3 id="info-box-header" class="board__heading"><img class="info-icon" src="assets/infoicon.svg"/> What are these?</h3>
            <div class="board__body">
                <p id="info-box-copy">The charts shown here are platform-wide initiatives. They take two points:</p>
                <ul style="list-style-type: disc;">
                    <li> How many repositories are affected by an initiative</li>
                    <li> How many repositories have met the initiatives requirements </li>
                </ul>
                <p>You can filter down to a teams compliance by choosing a team in the drop-down box to the top-right of this panel.</p>
                <div class="row col-xs-12 ">
                    <p>If you would like to suggest new initiatives, please provide an API we can consume and make some quantifiable calculations on.
                        For more details, please see the <a href="https://github.com/hmrc/platform-initiatives">Platform Initiatives GitHub page.</a></p>
                </div>
            </div>
        <table class="table table-striped">
            <tbody class="list">
            @initiatives.zipWithIndex.map{case (initiative, i) =>
                @if(initiative.targetProgress != 0){
                <tr class="col-sm-6">
                    <td>
                        @display match{
                            case DisplayType.Chart => {
                                <div class="initiativeName" style="width:500px;">
                                    <h3> @initiative.initiativeName </h3><br \>
                                </div>
                                <div id="chart_div_@initiative.initiativeName"></div>
                                <br>
                                <div style="max-width:500px; height:100px; word-wrap:break-word;">
                                    @MarkdownLoader.markdownFromString(initiative.initiativeDescription) match {
                                        case Right(s) => {
                                            @Html(s)
                                        }
                                        case Left(_) => {
                                            @initiative.initiativeDescription
                                        }
                                    }
                                </div>
                            }
                            case DisplayType.Progress => {
                                <div class="initiativeName" style="width:500px;">
                                    <h3> @initiative.initiativeName </h3>
                                    <progress class="progress" value="@initiative.currentProgress"
                                              max="@initiative.targetProgress">
                                        @initiative.currentProgress/@initiative.targetProgress
                                    </progress>
                                </div>
                            }
                        }
                    </td>
                </tr>
                    }
                }
            </tbody>
        </table>
    </form>
</div>
}

<script type="text/javascript">
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {
        @initiatives.zipWithIndex.map{case (initiative, i) =>
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'InitiativeName');
            data.addColumn('number', 'Count');
            data.addRows([
                ['@initiative.completedLegend', @initiative.currentProgress],
                ['@initiative.inProgressLegend', @initiative.targetProgress-@initiative.currentProgress]
            ]);
            var options =   { 'title'       : ''        ,
                              'width'       : "100%"    ,
                              'height'      : 200       ,
                              'chartArea'   : {'width' : '80%',
                                               'height': '80%'}
                            };
            var chart = new google.visualization.PieChart(document.getElementById('chart_div_@initiative.initiativeName'));
            chart.draw(data, options);
        }
    }
    </script>
<script>
    var options = { valueNames:     ['initiativeName'],
                    searchColumns:  ['initiativeName'] };
    var serviceList = new List('platform-initiatives', options);
</script>
