@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.{routes => appRoutes}
@import uk.gov.hmrc.cataloguefrontend.connector.{GitRepository, JenkinsJob, RepoType}
@import uk.gov.hmrc.cataloguefrontend.connector.model.{BobbyReport, Dependency}
@import uk.gov.hmrc.cataloguefrontend.teams.{RepoAndDependencies, routes => teamRoutes}
@import uk.gov.hmrc.cataloguefrontend.users.{UmpTeam, SlackInfo, routes => userRoutes}
@import uk.gov.hmrc.cataloguefrontend.view.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.leakdetection.LeakDetectionRepositorySummary
@import uk.gov.hmrc.cataloguefrontend.platforminitiatives.PlatformInitiative
@import uk.gov.hmrc.cataloguefrontend.prcommenter.PrCommenterComment
@import uk.gov.hmrc.cataloguefrontend.servicecommissioningstatus.CachedServiceCheck
@import uk.gov.hmrc.cataloguefrontend.servicemetrics.ServiceMetric
@import uk.gov.hmrc.cataloguefrontend.shuttering.ShutterState
@import uk.gov.hmrc.cataloguefrontend.vulnerabilities.TotalVulnerabilityCount
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.WhatsRunningWhere
@import java.net.URL
@import scala.concurrent.duration.Duration

@this(
  configuration: play.api.Configuration
, viewMessages : ViewMessages
)

@(
  teamName        : TeamName
, umpMyTeamsUrl   : String
, results         : ( Option[String]
                    , Seq[GitRepository]
                    , UmpTeam
                    , (Int, URL) // Open PRs raised by the team
                    , (Int, URL) // Open PRs for repos owned by the team
                    , Seq[LeakDetectionRepositorySummary]
                    , Seq[BobbyReport] // Production
                    , Seq[BobbyReport] // Latest
                    , Seq[ShutterState]
                    , Seq[PlatformInitiative]
                    , Seq[TotalVulnerabilityCount]
                    , Seq[TotalVulnerabilityCount]
                    , Seq[CachedServiceCheck]
                    , Seq[ServiceMetric]
                    , Seq[WhatsRunningWhere]
                    , Seq[JenkinsJob]
                    )
, canEditTeam: Boolean
)(implicit
  request: RequestHeader
)

@serviceMetricsLogDuration: Duration = @{
  configuration.get[Duration]("service-metrics.logDuration")
}

@standard_layout(teamName.asString, active = "teams") {
  @request.flash.get("error").map { msg =>
    <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
        @msg
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }
  @request.flash.get("success").map { msg =>
      <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
          @msg
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
  }

  <h1 class="page-heading mt-4">@teamName.asString</h1>
  @defining(results) { case (gitHubUrl, repos, umpTeam, openPrsRaisedByTeam, openPrsForReposOwnedByTeam, leaks, productionBobbyReports, latestBobbyReports, shutterStates, platformInitiatives, productionVulnerabilities, latestVulnerabilities, commissioningChecks, serviceMetrics, whatsRunningWhere, testJobs) =>

    <section class="section-wrapper">
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <div class="h4 mb-0">Details</div>
            </div>
            <div class="card-body">
              <dl id="team-description" class="row mb-0">
                <dt class="col-sm-4">Description:</dt>
                <dd class="col-sm-8">@umpTeam.description.getOrElse("")</dd>
              </dl>
              <dl id="team-documentation" class="row mb-0">
                <dt class="col-sm-4">Documentation:</dt>
                <dd class="col-sm-8">
                  @umpTeam.documentation.map { docs =>
                    <a href="@docs" target="_blank" rel="noreferrer noopener">Go to Confluence space<span class="glyphicon glyphicon-new-window" /></a>
                  }
                </dd>
              </dl>
              <dl id="team-slack-channels" class="row mb-0">
                <dt class="col-sm-4">Slack:</dt>
                <dd class="col-sm-8"></dd>
              </dl>

              @umpTeam.slack.map(addSlackInfo("Team", _))
              @umpTeam.slackNotification.map(addSlackInfo("Notification", _))
              @umpUpdateLink(isMemberBox = false)

              <dl id="github" class="row mb-0">
                <dt class="col-sm-4">GitHub:</dt>
                <dd class="col-sm-8">
                  @gitHubUrl.map { url =>
                    <a href=@url target="_blank" rel="noreferrer noopener"><img src="@routes.Assets.versioned("githubicon-green.svg")" alt="Link to Github" /> @umpTeam.teamName.asString<span class="glyphicon glyphicon-new-window" /></a>
                  }
                </dd>
              </dl>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          @defining(umpTeam.members.size > 16) { displayGrow =>
            <div class="card">
              <div class="card-header">
                <div class="h4 mb-0 float-start">Members</div>
                @if(canEditTeam) {
                  <div class="float-end">
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addUserToTeamModal">Add</button>
                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#removeUserFromTeamModal">Remove</button>
                  </div>
                }
              </div>
              <div @if(displayGrow){ class="content-grow content-grow-gradient" style="height:220px;"}>
                <div class="card-body content-grow-wrapper">
                    @if(umpTeam.members.isEmpty){
                      <p class="card-text col-6">@teamName.asString has no members.</p>
                    } else {
                      @if(umpTeam.nonHumanMembers.nonEmpty) {
                        <h5>Users</h5>
                      }
                      <ul id="team_members" class="list-unstyled" style="column-count: 2;">
                        @for(teamMember <- umpTeam.humanMembers) {
                          <li>
                            <a href="@userRoutes.UsersController.user(teamMember.username)">@teamMember.displayName</a>
                            @if(!teamMember.role.isUser) {
                              <span class="badge rounded-pill text-bg-secondary">@teamMember.role.displayName</span>
                            }
                          </li>
                        }
                      </ul>
                      @if(umpTeam.nonHumanMembers.nonEmpty) {
                        <h5 class="mt-3">Service Accounts</h5>
                        <ul class="list-unstyled" style="column-count: 2;">
                          @for(teamMember <- umpTeam.nonHumanMembers) {
                            <li>
                              <a href="@userRoutes.UsersController.user(teamMember.username)">@teamMember.displayName</a>
                              @if(!teamMember.role.isUser) {
                                <span class="badge rounded-pill text-bg-secondary">@teamMember.role.displayName</span>
                              }
                            </li>
                          }
                        </ul>
                      }
                    }
                </div>
              </div>
              @if(displayGrow) {
                <footer class="text-center">
                  <a id="see-all-expand-link" href="#" title="See all" class="content-grow-expand-link glyphicon glyphicon-chevron-down"></a>
                </footer>
              }
            </div>
          }
        </div>
      </div>

      @if(gitHubUrl.isDefined){
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card">
              <div class="card-header">
                <div class="h4 mb-0">Digital Services</div>
              </div>
              @defining(repos.flatMap(_.digitalServiceName).distinct.sorted) { digitalServices =>
                <div class="card-body">
                  @if(digitalServices.isEmpty) {
                    <p class="card-text col-6">@teamName.asString has no Digital Services.</p>
                  } else {
                    <ul class="list-unstyled">
                      @for(digitalService <- digitalServices) {
                        <li>@digitalService.asString</li>
                      }
                    </ul>
                  }
                </div>
              }
            </div>
          </div>
          <div class="col md-3">
            @shutteringPartial(teamName = Some(teamName), shutterStates)
          </div>
          <div class="col md-3">
            @healthPartial(teamName = Some(teamName), leaks, productionBobbyReports, latestBobbyReports, platformInitiatives, productionVulnerabilities, latestVulnerabilities, openPrsRaisedByTeam, openPrsForReposOwnedByTeam, commissioningChecks, serviceMetrics, whatsRunningWhere, testJobs, serviceMetricsLogDuration)
          </div>
          <div class="col md-3">
            @explorePartial(teamName = Some(teamName))
          </div>
        </div>
        @repositoriesPartial(repos, viewMessages)
      }
    </section>

    @if(canEditTeam) {
      <div class="modal fade" id="removeUserFromTeamModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="removeUserFromTeamModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeUserFromTeamModalTitle">Remove User from Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="remove-from-team-form" method="post" action="@teamRoutes.TeamsController.removeUserFromTeam(teamName)">
                    @csrfFormField
                    <div class="modal-body">
                        <input name="team" type="hidden" value="@umpTeam.teamName.asString">
                        <div class="mb-3">
                            <label for="user-select" class="form-label fw-bold">Select a member to remove</label>
                            <select id="user-select" name="user" class="form-select" required>
                                @if(umpTeam.nonHumanMembers.nonEmpty) {
                                  <optgroup label="Users">
                                }
                                @for(member <- umpTeam.humanMembers) {
                                    <option value="@member.username.asString">
                                      @member.displayName match {
                                        case Some(displayName) => {@displayName (@member.username.asString)}
                                        case None              => {@member.username.asString}
                                      }
                                    </option>
                                }
                                @if(umpTeam.nonHumanMembers.nonEmpty) {
                                  </optgroup>
                                  <optgroup label="Service Accounts">
                                    @for(member <- umpTeam.nonHumanMembers) {
                                      <option value="@member.username.asString">
                                        @member.displayName match {
                                          case Some(displayName) => {@displayName (@member.username.asString)}
                                          case None              => {@member.username.asString}
                                        }
                                      </option>
                                    }
                                  </optgroup>
                                }
                            </select>
                            <p class="mt-3">If the user is leaving the platform, please ensure you submit a <a href="https://confluence.tools.tax.service.gov.uk/pages/viewpage.action?pageId=160906302" target="_blank" rel="noreferrer noopener">leaver request<i class="glyphicon glyphicon-new-window"></i></a></p>
                            <p class="mt-1 mb-0">If this is the user's only team, they will need to be added to their new team before removal.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button id="remove-from-team-submit" class="btn btn-success" type="submit">Submit</button>
                    </div>
                </form>
            </div>
        </div>
      </div>
  
      <div class="modal fade" id="addUserToTeamModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addUserToTeamModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserToTeamModalTitle">Add User to Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="add-to-team-form" method="post" action=@teamRoutes.TeamsController.addUserToTeam(teamName)">
                    @csrfFormField
                    <div class="modal-body">
                        <input name="team" type="hidden" value="@umpTeam.teamName.asString">
                        <div class="mb-3 position-relative">
                            <label for="user-select" class="form-label fw-bold">Search for a user to add</label>
                            <input type="text" id="user-search" name="username" value="" class="form-control" required="required" autocomplete="off">
                            <div id="user-search-matches" class="search-matches-dropdown d-none"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button id="remove-from-team-submit" class="btn btn-success" type="submit">Submit</button>
                    </div>
                </form>
            </div>
        </div>
      </div>

      <script @CSPNonce.attr src="@routes.Assets.versioned("search-with-autocomplete.js")"></script>
      <script @CSPNonce.attr>
        const addUserModal = document.getElementById('addUserToTeamModal');
        addUserModal.addEventListener('shown.bs.modal', function() {
          if (inputSearch) { // in case opened and closed multiple times we tidy up and re-initialise
              inputSearch.removeEventListener('keydown', disableDefaults);
              inputSearch.removeEventListener('keyup', autoCompleteSearchInputListener);
              inputSearch.removeEventListener('focus', autoCompleteSearchInputListener);
          }
          
          autoCompleteInit({ // we can only initialise once it's visible
              formId: null, 
              inputSearchId: "user-search",
              matchesDivId: "user-search-matches",
              allowPartial: false,
              ignoreCase: true,
              fetchUrl: "/add-user-to-team-search",
              minSearch: 3
          });
        });

        addUserModal.addEventListener('hidden.bs.modal', function() {
           clearMatches();
        });
      </script>
    }
  }
}

@addSlackInfo(label: String, slackInfo: SlackInfo) = {
  @if(!slackInfo.hasValidUrl) {
    <dl id="slack-@label.toLowerCase" class="row mb-0">
      <dt class="col-sm-3 offset-1">@label:</dt>
      <dd class="col-sm-8">
        <p>@slackInfo.url <span class="glyphicon glyphicon-warning-sign" /></p>
        <p>Please change to a URL via <a href="@umpMyTeamsUrl" target="_blank" rel="noreferrer noopener">UMP<span class="glyphicon glyphicon-new-window" /></a></p>
      </dd>
    </dl>
  } else if (!slackInfo.hasValidName) {
    <dl id="slack-@label.toLowerCase" class="row mb-0">
      <dt class="col-sm-3 offset-1">@label:</dt>
      <dd class="col-sm-8">
        <a href="@slackInfo.url" target="_blank" rel="noreferrer noopener">Go to @label.toLowerCase channel<span class="glyphicon glyphicon-new-window" /></a>
      </dd>
    </dl>
  } else {
    <dl id="slack-@label.toLowerCase" class="row mb-0">
      <dt class="col-sm-3 offset-1">@label:</dt>
      <dd class="col-sm-8">
        <a href="@slackInfo.url" target="_blank" rel="noreferrer noopener">#@slackInfo.name<span class="glyphicon glyphicon-new-window" /></a>
      </dd>
    </dl>
  }
}

@umpUpdateLink(isMemberBox: Boolean) = {
  <p id="ump-correct-data-link" class="card-text">
    <small class="text-body-secondary">
        To update @teamName.asString team @if(isMemberBox) { members } else { details }, go to the <a href="@umpMyTeamsUrl" target="_blank" rel="noreferrer noopener">User Management Portal<span class="glyphicon glyphicon-new-window" /></a>
    </small>
  </p>
}
