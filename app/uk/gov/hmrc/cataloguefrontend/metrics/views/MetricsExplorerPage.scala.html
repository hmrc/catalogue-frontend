@*
* Copyright 2021 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import play.api.mvc.Call
@import uk.gov.hmrc.cataloguefrontend.metrics.model.{Group, Repository, DependencyName, MetricsEntry}
@import uk.gov.hmrc.cataloguefrontend.MetricsExplorerController
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.{ routes => appRoutes }
@import uk.gov.hmrc.cataloguefrontend.service.SearchByUrlService.FrontendRoutes
@import play.twirl.api.Html

@this(viewMessages: ViewMessages)

@(form          : Form[_],
groups          : Seq[Group],
repositories    : Seq[Repository],
dependencies    : Seq[DependencyName],
metricsEntries  : Seq[MetricsEntry])(implicit
request         : Request[_],
messagesProvider: MessagesProvider
)

@standard_layout("Metrics Explorer", "search") {
<html>
<head>
    <style>
        .grid-container {
          display: grid;
          grid-template-columns: auto auto auto auto auto auto;
          padding: 10px;
        }
        .grid-item {
          padding: 20px;
          font-size: 30px;
          text-align: center;
        }
        </style>
</head>

<header>
    <h1 id="search-service-header">Metrics Explorer</h1>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</header>

<div id="service-list">

    @if(form.hasGlobalErrors) {
    <div class="alert alert-error error">
        <a class="close" data-dismiss="alert">Ã—</a>
        <ul>
            @form.globalErrors.map { error =>
            <li>@error.format</li>
            }
        </ul>
    </div>
    }

    <div class="board">
        <div class="board__body">
            @helper.form(
            action =  appRoutes.MetricsExplorerController.search,
            'class -> "form-inline",
            'id    -> "search-by-dependency-form"
            ) {
            <table class="padded-table">
                <tr>
                    <td style="vertical-align: top;">
                        @helper.select(
                        form("group"),
                        helper.options(Seq("" -> Messages("metricsexplorer.select.group")) ++
                        groups.map(_.name.value).map(g => (g, g)) :_*),
                        '_label -> "",
                        '_class -> "form-group"
                        )
                        @helper.select(
                        form("repository"),
                        helper.options(Seq("" -> Messages("metricsexplorer.select.repository")) ++
                        repositories.map(_.name.value).map(t => (t, t)) :_*),
                        '_label -> "",
                        '_class -> "form-group"
                        )
                    </td>
                    <td>
                        @helper.select(
                        form("dependency"),
                        helper.options(Seq("" -> Messages("metricsexplorer.select.dependency")) ++
                        dependencies.map(_.value).map(t => (t, t)) :_*),
                        '_label -> "",
                        '_class -> "form-group"
                        )
                    </td>
                </tr>
                <tr>
                    <td valign="bottom">
                        <button id="search-button" class="btn btn-primary" type="submit">Search</button>
                    </td>
                </tr>
            </table>
            <div id="chart_div" align="center" class="grid-container"></div>
            }
        </div>
    </div>
</div>

<script>
    if (document.readyState != 'loading'){
        ready();
    } else {
        document.addEventListener('DOMContentLoaded', ready);
    }

    function ready() {
        document.getElementById("group").onchange = onGroupChange;
        document.getElementById("repository").onchange = updateDependenciesByRepo;
    }

    function onGroupChange(){
        updateDependenciesByGroup();
        updateRepositoriesByGroup();
    }

    function updateRepositoriesByGroup() {
        var group = document.getElementById("group").value;
        var repositoriesSelect = document.getElementById("repository");
        var existingRepoValue = repositoriesSelect.value;
        var repositoriesByGroup = {
            @groups.map { res =>
            '@{res.name.value}': [@for(a <- res.repos){
                '@a.value',
                }]
            ,
            }
        };
        var allRepos = [@for(a <- repositories){ '@a.name.value', }];

        while (repositoriesSelect.options.length > 0) {
            repositoriesSelect.remove(repositoriesSelect.options.length - 1);
        }
        var repos = group? repositoriesByGroup[group] : allRepos;
        if (repos) {
            var opt = document.createElement('option');
            opt.text = "@Messages("metricsexplorer.select.repository")";
            opt.value = "";
            repositoriesSelect.add(opt, null);
            for (i = 0; i < repos.length; i++)
            {
                var opt = document.createElement('option');
                opt.text = repos[i];
                opt.value = repos[i];
                opt.selected = repos[i] == '@{form("repositories").value}';
                repositoriesSelect.add(opt, null);
            }
        }
        if(repos.includes(existingRepoValue))
            repositoriesSelect.value = existingRepoValue;
    }

    function updateDependenciesByGroup() {
        var dependenciesSelect = document.getElementById("dependency");
        var group = document.getElementById("group").value;
        var existingDepValue = dependenciesSelect.value;
        var dependenciesByGroup = {
            @groups.map { res =>
                '@{res.name.value}': [
                    @for(a <- res.dependencies){
                        '@a.value',
                    }
                ],
            }
        }
        var allDependencies = [
            @for(a <- dependencies){ '@a.value', }
        ];

        while (dependenciesSelect.options.length > 0) {
            dependenciesSelect.remove(dependenciesSelect.options.length - 1);
        }
        var deps = group? dependenciesByGroup[group] : allDependencies;
        if (deps) {
            var opt = document.createElement('option');
            opt.text = "@Messages("metricsexplorer.select.dependency")";
            opt.value = "";
            dependenciesSelect.add(opt, null);
            for (i = 0; i < deps.length; i++)
            {
                var opt = document.createElement('option');
                opt.text = deps[i];
                opt.value = deps[i];
                opt.selected = deps[i] == '@{form("dependencies").value}';
                dependenciesSelect.add(opt, null);
            }
        }
        if(deps.includes(existingDepValue))
            dependenciesSelect.value = existingDepValue;
    }

    function updateDependenciesByRepo() {
        var dependenciesSelect = document.getElementById("dependency");
        var existingDepValue = dependenciesSelect.value;
        var repo = document.getElementById("repository").value;
        var group = document.getElementById("group").value;
        var dependenciesByRepoByGroup = {
            @for(res <- repositories){
              '@{res.name.value}': {
                  @for(mapping <- res.dependencies.toSeq){
                      '@{mapping._1.value}': [
                        @for(d <- mapping._2){
                            '@{d.value}',
                        }
                      ],
                  }
              },
            }
        };

        var allDependenciesByRepo = {
            @repositories.map { res =>
            '@{res.name.value}': [@for(a <- res.allDependencies){
                '@a.value',
                }]
            ,
            }
        };

        var allDependencies = [@for(a <- dependencies){ '@a.value', }];

        while (dependenciesSelect.options.length > 0) {
            dependenciesSelect.remove(dependenciesSelect.options.length - 1);
        }

        var deps = repo? (group?dependenciesByRepoByGroup[repo][group]: allDependenciesByRepo[repo]): allDependencies;
        if (deps) {
            var opt = document.createElement('option');
            opt.text = "@Messages("metricsexplorer.select.dependency")";
            opt.value = "";
            dependenciesSelect.add(opt, null);
            for (i = 0; i < deps.length; i++)
            {
                var opt = document.createElement('option');
                opt.text = deps[i];
                opt.value = deps[i];
                opt.selected = deps[i] == '@{form("dependencies").value}';
                dependenciesSelect.add(opt, null);
            }
        }
        if(deps.includes(existingDepValue))
            dependenciesSelect.value = existingDepValue
    }
</script>

<script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        const chartDiv = document.getElementById('chart_div');

        function drawChart() {

            @metricsEntries match {
                case Nil => {}
                case entries => {
                    var options = {
                                    'height'   : 150,
                                    'width'   : 150,
                                    'colors': ['green', 'Red'],
                                    'chartArea': { 'width': '100%', 'height': '100%'},
                                    'legend': 'none'
                                  };

                    const arr = [
                        @for(e <- entries){
                            [
                                '@e.dependency.value',
                                [@for(a <- e.asPercentage){ @a, }]
                            ],
                        }
                    ];

                    arr.forEach( ([key, [happy, unhappy]]) => {
                        let container = chartDiv.appendChild(document.createElement('grid-item'));

                        <!--drawing pie chart-->
                        let data = new google.visualization.DataTable();
                        data.addColumn('string', 'Version');
                        data.addColumn('number', 'Count');
                        data.addRows([["Happy", happy], ["Unhappy", unhappy]]);
                        let chart = new google.visualization.PieChart(container);
                        chart.draw(data, options);

                        <!--manual caption for the chart-->
                        let p = document.createElement("p");
                        let h2Element = document.createElement('h3');
                        h2Element.innerText = key;
                        p.appendChild(h2Element);
                        container.appendChild(p);
                    })
                }
            }
        }
    </script>
</html>
}
