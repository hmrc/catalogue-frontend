@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.costs.model.ServiceDeploymentConfigGrouped
@import views.html.helper.select

@this(viewMessages: ViewMessages)

@(
        configs         : Seq[ServiceDeploymentConfigGrouped],
        slotsCostPerYear: Double,
        teams: Seq[Team],
        form: Form[_],
)(implicit messages: Messages, request: RequestHeader)

@implicitField = @{
    helper.FieldConstructor(helper.catalogueFieldConstructor.f)
}

@standard_layout("Estimated Cost Explorer", active = "explore") {
    <h1 class="page-heading mt-4">
        Estimated Cost Explorer
    </h1>

    <div id="costs-summary-list">
        <form id="costs-summary-form" action="/estimated-cost-explorer" method="get">
            <div id="repos-form-row" class="row">
                <div class="col-md-6">
                    <dl id="search_field">
                        <dt>
                            <label for="search" class="form-label">Name</label>
                        </dt>
                        <dd>
                            <input class="search form-control" id="search" type="search" name="name" value='@form("name").value' autofocus>
                        </dd>
                    </dl>
                </div>
                <div class="col-md-3">
                @select(
                    field = form("team"),
                    options = teams.map(t => t.name.asString -> t.name.asString),
                    Symbol("_default") -> "All",
                    Symbol("_label") -> "Team",
                    Symbol("_labelClass") -> "form-label",
                    Symbol("id") -> "team-filter",
                    Symbol("class") -> "form-select"
                )
                </div>
            </div>
        </form>

        <table class="table table-striped sticky-header table-layout: fixed" id="repo-list">
            <thead>
                <tr>
                    <th rowspan="2"><button role="button" id="name" data-sort="repo-name" class="fw-bold sort no-border">
                        Application Name</button></th>
                    <th colspan="2" style="text-align: center">Integration</th>
                    <th colspan="2" style="text-align: center">Development</th>
                    <th colspan="2" style="text-align: center">QA</th>
                    <th colspan="2" style="text-align: center">Staging</th>
                    <th colspan="2" style="text-align: center">External Test</th>
                    <th colspan="2" style="text-align: center">Production</th>
                    <th rowspan="2">
                        <button role="button" id="yearlyCost" data-sort="yearly-cost" class="fw-bold sort no-border">
                            Estimate Cost (yearly)
                        </button>
                    </th>
                </tr>
                <tr>
                    <th>Slots</th>
                    <th>Instances</th>
                    <th>Slots</th>
                    <th>Instances</th>
                    <th>Slots</th>
                    <th>Instances</th>
                    <th>Slots</th>
                    <th>Instances</th>
                    <th>Slots</th>
                    <th>Instances</th>
                    <th>Slots</th>
                    <th>Instances</th>
                </tr>
            </thead>
            <tbody class="list" id="matches">
            @configs.zipWithIndex.map { case (config, index) =>
            <tr>
                <td class="repo-name" id="row@{
                    index
                }_name"><a id="link-to-@config.serviceName-page" href="/repositories/@config.serviceName">@config.serviceName</a></td>
                <td style="text-align: center">@config.getIntegrationEnvironment.map(_.slots)</td>          @* Integration - slots *@
                <td style="text-align: center">@config.getIntegrationEnvironment.map(_.instances)</td>      @* Integration - instances *@
                <td style="text-align: center">@config.getDevelopmentEnvironment.map(_.slots)</td>          @* Development - slots *@
                <td style="text-align: center">@config.getDevelopmentEnvironment.map(_.instances)</td>      @* Development - instances *@
                <td style="text-align: center">@config.getQAEnvironment.map(_.slots)</td>                   @* QA - slots *@
                <td style="text-align: center">@config.getQAEnvironment.map(_.instances)</td>               @* QA - instances *@
                <td style="text-align: center">@config.getStagingEnvironment.map(_.slots)</td>              @* Staging - slots *@
                <td style="text-align: center">@config.getStagingEnvironment.map(_.instances)</td>          @* Staging - instances *@
                <td style="text-align: center">@config.getExternalTestEnvironment.map(_.slots)</td>         @* External Test - slots *@
                <td style="text-align: center">@config.getExternalTestEnvironment.map(_.instances)</td>     @* External Test - instances *@
                <td style="text-align: center">@config.getProductionEnvironment.map(_.slots)</td>           @* Production - slots *@
                <td style="text-align: center">@config.getProductionEnvironment.map(_.instances)</td>       @* Production - instances *@
                <td style="text-align: center">Â£@config.totalEstimatedCostFormatted(slotsCostPerYear)       @* Estimated costs *@
                </td>
                <td class="yearly-cost" style="display:none;" id="row@{
                    index
                }_yearlyCost">@config.totalEstimatedCosts(slotsCostPerYear)
            </td>
            </tr>
            }
            </tbody>
        </table>
    </div>


}
    <!-- listjs configuration -->
<script @CSPNonce.attr>
        let options = {
            valueNames: ['repo-name', 'yearly-cost'],
            searchColumns: ['repo-name'],
            searchDelay: 350
        };

        let serviceList = new List('costs-summary-list', options);

        let searchBox = document.getElementById('search');
        // set autofocus cursor to right of text in search box
        let length = searchBox.value.length;
        searchBox.focus();
        searchBox.setSelectionRange(length, length);
        // re-search the list upon page load.
        serviceList.search(searchBox.value);
</script>
<script @CSPNonce.attr>
        ["team-filter"]
                .forEach(function (id) {
                    document.getElementById(id).addEventListener("change", function () {
                        document.getElementById("costs-summary-form").submit();
                    });
                });
</script>