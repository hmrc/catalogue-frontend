@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.model.Environment
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.{ProfileName, ProfileType, WhatsRunningWhere, ViewMode}
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.routes
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.model.ServiceDeploymentConfigSummary
@import views.html.partials.{WhatsRunningWhereVersions, WhatsRunningWhereInstances}

@this(viewMessages: ViewMessages)

@( environments       : Seq[Environment]
 , whatsRunning       : Seq[WhatsRunningWhere]
 , selectedProfileType: ProfileType
 , profileNames       : Seq[ProfileName]
 , form               : Form[_]
 , showDiff           : Boolean
 , serviceDeployments : Seq[ServiceDeploymentConfigSummary]
 , maxMemory          : Double
 , viewMode           : ViewMode
)(implicit
  messages            : Messages
, request             : RequestHeader
)

@standard_layout("What's Running Where?", active = "whats-running-where") {
    <h1 class="page-heading mt-4">What's Running Where?</h1>

    @if(form.hasErrors) {
        <div class="alert alert-danger" role="alert">
            <ul class="list">
            @form.errors.map { error =>
                <li class="alert-danger"> @Messages(error.message, error.args: _*)</li>
            }
            </ul>
        </div>
    }

    <div id="whats-running-where-list">
        <form id="form" method="get">
            <input type="hidden" id="profile_type" name="profile_type" value="@selectedProfileType.asString" />
            @if(showDiff) {
                <input type="hidden" id="showDiff" name="showDiff" value="true" />
            }
            <div class="row mb-3">
                <label for="search" class="col-md-2 col-form-label fw-bold">Application name:</label>
                <div class="col-md-4">
                    <input class="search form-control" id="search" type="text" name="application_name" value='@form("application_name").value' autofocus>
                </div>
            </div>
            <ul class="nav nav-tabs mb-2">
                @ProfileType.values.map(profileTypeTab)
            </ul>
            <div class="tab-content">
                <div class="tab-pane show active in mb-4" role="tabpanel">
                    <select class="form-select float-start mb-4" id="profile_name" name="profile_name" style="width: 200px">
                        @defining(Seq("" -> Messages("whatsrunningwhere.select.profile")) ++ profileNames.map(_.asString).map(p => (p, p))){ options =>
                            @options.map(selectOption(form("profile_name").value))
                        }
                    </select>
                    <select class="form-select float-end mb-4" id="view_mode" name="view_mode" style="width: 200px">
                        <option @if(viewMode.asString == "versions") {selected="selected"} value="versions">Versions</option>
                        <option @if(viewMode.asString == "instances"){selected="selected"} value="instances">Instances</option>
                    </select>
                </div>
            </div>
        </form>
        <table class="table table-striped sticky-header" id="service-list">
            <thead>
                <th><button role="button" class="sort no-border fw-bold" data-sort="application-name">Application Name</button></th>
                @if(viewMode.asString == "versions") {
                    @environments.map { env =>
                        <th class="wrw-environment-head">@env.displayString</th>
                    }
                } else {
                    @environments.map { env =>
                        <th class="wrw-environment-head"><button role="button" class="sort no-border fw-bold" data-sort="@env.asString">@env.displayString</button></th>
                    }
                }
            </thead>
            @if(viewMode.asString == "versions") {
                @WhatsRunningWhereVersions(whatsRunning, environments, showDiff)
            } else {
                @WhatsRunningWhereInstances(serviceDeployments, environments, maxMemory)
            }
        </table>
    </div>
}
<script @CSPNonce.attr>
    var searchBox = document.getElementById("search");

    @if((viewMode.asString == "versions" && whatsRunning.nonEmpty) || serviceDeployments.nonEmpty) {
      var options = { valueNames: [ 'application-name', 'development', 'integration', 'qa', 'staging', 'externaltest', 'production'] };
      var serviceList = new List('whats-running-where-list', options);
      // re-search the list upon page load.
      serviceList.search(searchBox.value);
    }


    // set autofocus cursor to right of text in search box
    var length = searchBox.value.length;
    searchBox.focus();
    searchBox.setSelectionRange(length, length);

    function selectProfileType(profileType) {
        document.getElementById('profile_type').value = profileType;
        document.getElementById('profile_name').value = '';
        document.getElementById('form').submit();
    };

    ["profile_name", "view_mode"]
      .forEach(function(id) {
        document.getElementById(id).addEventListener("change", function() {
          document.getElementById("form").submit();
        });
      });
</script>

@selectOption(selected: Option[String])(option: (String, String)) = {
    <option value="@{option._1}" @{if(selected.exists(_ == option._1)) "selected"}>
    @option._2
    </option>
}

@profileTypeTab(profileType: ProfileType) = {
    @defining(profileType == selectedProfileType){ active =>
        <li id="tab-@profileType.asString" class="nav-item">
            <a id="@profileType.asString-tab" class="nav-link @if(active){active}" href="@routes.WhatsRunningWhereController.releases()">
                @profileType Profile
            </a>
            <script @CSPNonce.attr>
              document.getElementById("@profileType.asString-tab").addEventListener("click", function(e) {
                e.preventDefault() // prevent following the href as we submit the form via js.
                selectProfileType('@profileType.asString')
              });
            </script>
        </li>
    }
}
