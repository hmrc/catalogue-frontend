@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import helper._
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.DeploymentTimelineEvent
@import uk.gov.hmrc.cataloguefrontend.routes.CatalogueController
@import java.time.Instant
@import uk.gov.hmrc.cataloguefrontend.service.ServiceDependencies
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.DeploymentGraphService
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.TimelinePalette
@import uk.gov.hmrc.cataloguefrontend.DateHelper._

@this()


@(service: String,
  start   : Instant,
  end     : Instant,
  events  : Seq[DeploymentTimelineEvent],
  slugInfo: Seq[ServiceDependencies],
  services: Seq[String]
)(implicit
  request: RequestHeader
)

@colorForVersion(version: String) = @{
    if(version == DeploymentGraphService.notDeployedMessage) {
      "color: #ccc"
    } else {
      TimelinePalette.rgb(Math.abs(version.hashCode) % TimelinePalette.rgb.length)
    }
}

@standard_layout("Deployment Timeline", "deployment-timeline") {

    <style>
        .timeline-tooltip {
            padding: 6px;
        }
    </style>
    <script @CSPNonce.attr type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script @CSPNonce.attr type="text/javascript">
        google.charts.load("current", {packages:["timeline"]});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {

            let data = [
                @events.map { e =>
                    ['@e.env',
                    '@{e.version.toString}',
                    makeToolTip(
                        '@{e.version}',
                        '@{e.userName}',
                        '@{e.displayStart.getOrElse(e.start).displayFormat}',
                        '@{e.displayEnd.getOrElse(e.end).displayFormat}',
                        @{java.time.Duration.between(e.displayStart.getOrElse(e.start), e.displayEnd.getOrElse(e.end)).toDays},
                        '@{slugInfo.find(_.version == e.version).fold("unknown")(x => s"${x.java.version} ${x.java.vendor}")}',
                    ),
                    '@colorForVersion(e.version.toString)',
                    new Date(@{e.start.toEpochMilli}),
                    new Date(@{e.end.toEpochMilli}),
                ], }

            ]

            let options = {tooltip: { isHtml: true }, enableInteractivity: true};
            let container = document.getElementById('history-chart');
            if (container == null) return
            let chart = new google.visualization.Timeline(container);
            let dataTable = new google.visualization.DataTable();
            dataTable.addColumn({ type: 'string', id: 'Position' });
            dataTable.addColumn({ type: 'string', id: 'Name' });
            dataTable.addColumn({ type: 'string', role: 'tooltip' });
            dataTable.addColumn({ type: 'string', role: 'style'});
            dataTable.addColumn({ type: 'date', id: 'Start' });
            dataTable.addColumn({ type: 'date', id: 'End' });

            dataTable.addRows(data);
            chart.draw(dataTable, options);
        }

        function makeToolTip(ver, user, start, end, days, java) {
            if (ver === "@DeploymentGraphService.notDeployedMessage") {
                return `<div class="timeline-tooltip">No deployment events found in this date range</div>`
            }
            return `<div class="timeline-tooltip" style="width:250px">
                        <table class="table table-striped" style="margin-bottom:0px">
                            <tr><th>${ver}</th><td>Deployed for ${days} days</td></tr>
                            <tr><th>By</th><td>${user}</td></tr>
                            <tr><th>From</th><td>${start} UTC</td></tr>
                            <tr><th>To</th><td>${end} UTC</td></tr>
                            <tr><th>Java</th><td>${java}</td></tr>
                        </table>
                    </div>`
        }
    </script>
    <header>
        <h1>Deployment Timeline @if(service != ""){<a id="link-to-service-info-page" href="@CatalogueController.service(service)">- @service</a>}</h1>
    </header>
    <form id="form" action="" method="get">
        <div class="form-group row">
            <div class="col-md-6">
                <label for="service" title="Search by service name" data-toggle="tooltip">Service</label>
                <select name="service" id="service" class="form-control">
                    <option value=""></option>
                    @services.map { s => <option value="@s" @if(service.equalsIgnoreCase(s)) { selected="true" } >@s</option> }
                </select>
            </div>

            <div class="col-md-2">
                <label for="start" title="From the start of this day" data-toggle="tooltip">Date From</label>
                <input type="date" id="start" name="start" value="@start.asPattern("yyyy-MM-dd")" class="form-control" style="line-height: 20px">
            </div>
            <div class="col-md-2">
                <label for="end" title="To the end of this day" data-toggle="tooltip" >Date To</label>
                <input type="date" id="end" name="end" value="@end.asPattern("yyyy-MM-dd")" class="form-control" style="line-height: 20px">
            </div>
            <div class="col-md-2" style="padding-top: 40px;">
                <input type="submit" value="Submit" class="form-control btn btn-primary">
            </div>
        </div>
    </form>

    @if(events.isEmpty) {
        @if(start.equals(end) || start.isAfter(end)) {
            <p class="red">Start date must be before the End date.</p>
        }
        @if(services.contains(service)) {
            <p>No data in this date range.</p>
        }
    } else {
        <div id="history-chart" style="height: 300px;"></div>
    }
}

<script @CSPNonce.attr>
  ["start", "end", "service"]
    .forEach(function(id) {
      document.getElementById(id).addEventListener("change", function() {
        document.getElementById("form").submit();
      });
    });
</script>
