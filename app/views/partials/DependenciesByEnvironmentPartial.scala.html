@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import partials.ServiceDependenciesPartial
@import uk.gov.hmrc.cataloguefrontend.connector.{DeploymentVO, RepositoryDetails, TargetEnvironment}
@import uk.gov.hmrc.cataloguefrontend.connector.model.{Dependencies, Dependency, Version}
@import uk.gov.hmrc.cataloguefrontend.model.Environment
@import uk.gov.hmrc.cataloguefrontend.shuttering.ShutterState
@import uk.gov.hmrc.cataloguefrontend.{ServiceInfoView, ViewMessages}


@this(dependenciesPartial: ServiceDependenciesPartial, viewMessages: ViewMessages)

@(service                      : RepositoryDetails,
  latestDependencies           : Seq[Dependency],
  dependenciesByEnvironmentName: Map[String, Seq[Dependency]],
  versionByEnvironmentName     : Map[String, Version],
  latestVersion                : Option[Version],
  shutterState                 : Map[Environment, ShutterState]
)(implicit messages: Messages)

<ul id="environmentTabs" class="nav nav-tabs" role="tablist">
    <!-- we hard-code 'latest' as it is not a deployment 'environment' -->
    <li class="nav-item active">
        <a id="latest-tab" class="nav-link" data-toggle="tab" href="#latest-pane" role="tab" aria-controls="latest" aria-selected="true">
            <div class="board">
                <div class="board__heading">
                    <h4 class="environment-name">Latest</h4>
                    @renderVersion(latestVersion)
                </div>
                <span class="board__body">
                    @renderShutterStatusBadge(false)
                    @renderBobbyRuleViolationBadges(
                       forEnvironment = "latest",
                       withDependencies = latestDependencies
                    )
                </span>
            </div>
        </a>
    </li>

    @for(environment <- service.environments.getOrElse(Seq.empty)) {
    <li class="nav-item">
        <a id="@{environment.id}-tab" class="nav-link" data-toggle="tab" href="#@{environment.id}-pane" role="tab" aria-controls="@environment.id" aria-selected="false">
            <div class="board">
                <div class="board__heading">
                    <h4 class="environment-name">@environment.name</h4>
                    @renderVersion(ServiceInfoView.lookupByTargetEnvironment(versionByEnvironmentName, environment))
                </div>
                <div class="board__body">
                    @renderShutterStatusBadge(ServiceInfoView.isShuttered(withShutterState = shutterState)(inEnvironment = environment))
                    @renderBobbyRuleViolationBadges(
                      forEnvironment   = environment.name,
                      withDependencies = ServiceInfoView.lookupByTargetEnvironment(dependenciesByEnvironmentName, environment).getOrElse(Seq.empty)
                    )
                </div>
            </div>
        </a>
    </li>
    }
</ul>

<div id="environmentPanes" class="tab-content environment-panes">
    <!-- we hard-code 'latest' as it is not a deployment 'environment' -->
    <div id="latest-pane" class="tab-pane active" role="tabpanel" aria-labelledby="latest-tab">
        <!-- no telemetry section for 'latest' -->
        <div class="row">
            <div class="col-md-12">
                @dependenciesPartial(latestDependencies, "platform-dependencies-latest")
            </div>
        </div>
    </div>

    @for(environment <- service.environments.getOrElse(Seq.empty)) {
    <div id="@{environment.id}-pane" class="tab-pane" role="tabpanel" aria-labelledby="@{environment.id}-tab">
        <div class="row">
            <div class="col-md-12">
                <div id="@{environment.id}-telemetry" class="board">
                    <h3 class="board__heading">Telemetry</h3>
                    <div class="board__body">
                        <ul class="list list--minimal">
                            @if(environment.services.isEmpty) {
                            <li class="list-item">
                                Not deployed
                            </li>
                            } else {
                            @for(tool <- environment.services) {
                            <li class="list-item col-xs-6">
                                <a id="link-to-@{tool.id}-@{environment.id}" href="@{tool.url}" target="_blank">
                                    @{tool.displayName}<span class="glyphicon glyphicon-new-window"></span>
                                </a>
                            </li>
                            }
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                @dependenciesPartial(
                    ServiceInfoView.lookupByTargetEnvironment(dependenciesByEnvironmentName, environment).getOrElse(Seq.empty)
                  , s"platform-dependencies-${environment.id}"
                  )
            </div>
        </div>
    </div>
    }
</div>

@renderVersion(optVersion: Option[Version]) = {
    @if(optVersion.isDefined) {
        <p class="small">@optVersion.get</p>
    } else {
        <!-- needed to ensure each tab nav-item has the same height -->
        <p class="small">&nbsp;</p>
    }
}

@renderShutterStatusBadge(isShuttered: Boolean) = {
    @if(isShuttered) {
        <div class="environment-badge shutter-badge" data-toggle="tooltip" data-placement="top" title="@messages("shuttered.badge")"></div>
    } else {
        <div class="environment-badge no-badge"></div>
    }
}

@renderBobbyRuleViolationBadges(forEnvironment: String, withDependencies: Seq[Dependency]) = {
    @renderActiveBobbyRuleViolationBadge(forEnvironment, withDependencies)
    @renderPendingBobbyRuleViolationBadge(forEnvironment, withDependencies)
}

@renderActiveBobbyRuleViolationBadge(forEnvironment: String, withDependencies: Seq[Dependency]) = {
    @if(withDependencies.exists(_.activeBobbyRuleViolations.nonEmpty)) {
        <div id="bobby-violation-active-badge-@{forEnvironment}" class="environment-badge bobby-violation-active-badge"
             data-toggle="tooltip" data-placement="top" title="@messages("bobbyrules.active.badge")"></div>
    } else {
        <div id="bobby-violation-active-badge-@{forEnvironment}" class="environment-badge no-badge"></div>
   }
}

@renderPendingBobbyRuleViolationBadge(forEnvironment: String, withDependencies: Seq[Dependency]) = {
    @if(withDependencies.exists(_.pendingBobbyRuleViolations.nonEmpty)) {
        <div id="bobby-violation-pending-badge-@{forEnvironment}" class="environment-badge bobby-violation-pending-badge"
             data-toggle="tooltip" data-placement="top" title="@messages("bobbyrules.pending.badge")"></div>
    } else {
        <div id="bobby-violation-pending-badge-@{forEnvironment}" class="environment-badge no-badge"></div>
    }
}
