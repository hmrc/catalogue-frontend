@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.connector.model.{Dependency, Version}
@import uk.gov.hmrc.cataloguefrontend.model.{Environment, SlugInfoFlag}
@import uk.gov.hmrc.cataloguefrontend.shuttering.{ShutterState, ShutterStatusValue}
@import uk.gov.hmrc.cataloguefrontend.{EnvData, ViewMessages}
@import uk.gov.hmrc.cataloguefrontend.connector.model.DependencyScope

@this(
  dependenciesPartial: DependenciesPartial,
  viewMessages       : ViewMessages
)

@(
  serviceName: String,
  envDatas   : Map[SlugInfoFlag, EnvData]
)(implicit messages: Messages)


<div class="card"><div class="card-header">
    <ul id="environmentTabs" class="nav nav-tabs card-header-tabs" role="tablist">
        @for(slugInfoFlag <- SlugInfoFlag.values) {
            @defining(envDatas.get(slugInfoFlag)) { optEnvData =>
                <li class="nav-item" role="presentation">
                    <button id="@{
                        slugInfoFlag.asString
                    }-tab" class="nav-link @if(slugInfoFlag == SlugInfoFlag.ForEnvironment(Environment.Production)) { active" aria-selected="true" } else {
                    " aria-selected="false" } data-bs-toggle="tab" data-bs-target="#@{
                    slugInfoFlag.asString
                }-pane" type="button" role="tab" aria-controls="@slugInfoFlag.asString-pane" >
                    <span>
                        <span>
                            <h5 id="environment-name" class="mb-0">@slugInfoFlag.displayString</h5>
                            @renderVersion(optEnvData.map(_.version))
                        </span>
                        <span>
                            @renderShutterStatusBadge(optEnvData.flatMap(_.optShutterState))
                            @defining(optEnvData.toSeq.flatMap(_.repoModules).flatMap(_.allDependencies)) { dependencies =>
                                @renderActiveBobbyRuleViolationBadge(slugInfoFlag, dependencies)
                                @renderPendingBobbyRuleViolationBadge(slugInfoFlag, dependencies)
                            }
                        </span>
                    </span>
                    </button>
                </li>
            }
        }
    </ul>
</div>

<div id="environmentPanes" class="card-body tab-content">
  @for(slugInfoFlag <- SlugInfoFlag.values) {
    @defining(envDatas.get(slugInfoFlag)){ optEnvData: Option[EnvData] =>
      <div id="@{slugInfoFlag.asString}-pane" class="tab-pane fade @if(slugInfoFlag == SlugInfoFlag.ForEnvironment(Environment.Production)) { show active }" role="tabpanel" aria-labelledby="@{slugInfoFlag.asString}-tab" tabindex="0">

        @if(slugInfoFlag != SlugInfoFlag.Latest) {
          @optEnvData.map{envData =>
          <div id="@{slugInfoFlag.asString}-telemetry" class="card mb-3">
                  <div class="card-header">
                      <h3 class="mb-0">Telemetry</h3>
                  </div>
                      <div class="card-body container">
                          <ul class="list-unstyled mb-0 row row-cols-4">
                            @if(envData.telemetryLinks.isEmpty) {
                               <li class="list-item">
                                  Not deployed
                              </li>
                            } else {
                              @for(tool <- envData.telemetryLinks) {
                                <li class="list-item col">
                                  <div class="row">
                                    <a id="link-to-@{tool.id}-@{slugInfoFlag.asString}" href="@{tool.url}" target="_blank" rel="noreferrer noopener">
                                        @tool.cls.map{c =>
                                          <span class="@c"></span>
                                        }
                                        @{tool.displayName} Queries
                                        <span class="glyphicon glyphicon-new-window"></span>
                                    </a>
                                  </div>
                                </li>
                              }
                              @for(nonPerformantQueryLink <- envData.nonPerformantQueryLinks) {
                                <li class="list-item col">
                                  <div class="row">
                                    <a id="link-to-@{nonPerformantQueryLink.id}-@{slugInfoFlag.asString}" href="@{nonPerformantQueryLink.url}" target="_blank" rel="noreferrer noopener">
                                        @nonPerformantQueryLink.cls.map{c =>
                                          <span class="@c"></span>
                                        }
                                        @{nonPerformantQueryLink.displayName} Queries
                                        <span class="glyphicon glyphicon-new-window"></span>
                                    </a>
                                  </div>
                                </li>
                              }
                            }
                          </ul>
                      </div>
          </div>
          }
        }

        @defining(optEnvData.toSeq.flatMap(_.repoModules).flatMap(_.allDependencies)){ dependencies =>

          <div class="row">
            <div class="col-md-12">
              @dependenciesPartial(
                dependencies.filter(_.scope.contains(DependencyScope.Compile))
              , s"platform-dependencies-${slugInfoFlag.asString}"
              , "Compile Dependencies"
              , serviceName
              , optEnvData.map(_.version)
              )
            </div>
          </div>

          @defining(dependencies.filter(_.scope.contains(DependencyScope.Test))) { testDependencies =>
            @if(testDependencies.nonEmpty){
              <div class="row">
                <div class="col-md-12">
                  @dependenciesPartial(
                    testDependencies
                  , s"test-dependencies-${slugInfoFlag.asString}"
                  , "Test Dependencies"
                  , serviceName
                  , optEnvData.map(_.version)
                  )
                </div>
              </div>
            }
          }

          @defining(dependencies.filter(_.scope.contains(DependencyScope.It))) { itDependencies =>
            @if(itDependencies.nonEmpty){
              <div class="row">
                <div class="col-md-12">
                  @dependenciesPartial(
                    itDependencies
                  , s"it-dependencies-${slugInfoFlag.asString}"
                  , "Integration Test Dependencies"
                  , serviceName
                  , optEnvData.map(_.version)
                  )
                </div>
              </div>
            }
          }

          @defining(dependencies.filter(_.scope.contains(DependencyScope.Build))) { buildDependencies =>
            @if(buildDependencies.nonEmpty) {
              <div class="row">
                <div class="col-md-12">
                  @dependenciesPartial(
                    buildDependencies
                  , s"build-dependencies-${slugInfoFlag.asString}"
                  , "Sbt Plugins"
                  , serviceName
                  , optEnvData.map(_.version)
                  )
                </div>
              </div>
            }
          }
        }
      </div>
    }
  }
</div>
</div>

@renderVersion(optVersion: Option[Version]) = {
  @optVersion match {
    case Some(version) => { <p class="small mb-1">@version</p> }
    case None          => { <p class="small mb-1">&nbsp;</p> <!-- needed to ensure each tab nav-item has the same height --> }
  }
}

@renderShutterStatusBadge(optShutterState: Option[ShutterState]) = {
  @if(optShutterState.exists(_.status.value == ShutterStatusValue.Shuttered)) {
    <span class="environment-badge shutter-badge" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="@messages("shuttered.badge")"></span>
  } else {
    <span class="environment-badge no-badge"></span>
  }
}

@renderActiveBobbyRuleViolationBadge(slugInfoFlag: SlugInfoFlag, dependencies: Seq[Dependency]) = {
  @if(dependencies.exists(_.activeBobbyRuleViolations.nonEmpty)) {
    <span id="bobby-violation-active-badge-@{slugInfoFlag.asString}" class="environment-badge bobby-violation-active-badge"
          data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="@messages("bobbyrules.active.badge")"></span>
  } else {
    <span id="bobby-violation-active-badge-@{slugInfoFlag.asString}" class="environment-badge no-badge"></span>
  }
}

@renderPendingBobbyRuleViolationBadge(slugInfoFlag: SlugInfoFlag, dependencies: Seq[Dependency]) = {
  @if(dependencies.exists(_.pendingBobbyRuleViolations.nonEmpty)) {
    <span id="bobby-violation-pending-badge-@{slugInfoFlag.asString}" class="environment-badge bobby-violation-pending-badge"
          data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="@messages("bobbyrules.pending.badge")"></span>
  } else {
    <span id="bobby-violation-pending-badge-@{slugInfoFlag.asString}" class="environment-badge no-badge"></span>
  }
}
