@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.service.ServiceDependencies
@import uk.gov.hmrc.cataloguefrontend.service.ServiceDependency
@import uk.gov.hmrc.cataloguefrontend.service.DependenciesService
@import uk.gov.hmrc.cataloguefrontend.connector.model.{JDKVersion, Oracle, OpenJDK}
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.model.SlugInfoFlag
@import play.twirl.api.Html
@import uk.gov.hmrc.cataloguefrontend.{ routes => appRoutes }

@this(viewMessages: ViewMessages)

@(jdkVersions: List[JDKVersion],
  flags       : Seq[SlugInfoFlag],
  teams       : Seq[Team],
  selectedFlag: SlugInfoFlag,
  selectedTeam: Option[Team]
)(implicit
  request: RequestHeader
)

@standard_layout(s"JDK Versions", "dependencies") {
    <header>
        <h1 id="jdk-header">JDK Versions: @selectedFlag.asString</h1>

        <script @CSPNonce.attr type="text/javascript" src="@controllers.routes.Assets.versioned("charts-loader-51.js")"></script>
    </header>

    <div class="row">
        <div class="col-sm-6" >
            <h4>Versions</h4>
            <div id="chart_div"></div>
        </div>
        <div class="col-sm-6" >
            <h4>Vendors</h4>
            <div id="chart_vendor_div"></div>
        </div>
    </div>

    <hr>
    <div>
        <form id="form" method="get" action="@selectedFlag.asString">
            <div class="form-group row">
                <div class="col-md-3">
                    <label for="flag">Environment:</label>
                    <select class="form-control" id="flag" name="flag">
                        @flags.map { flag =>
                            <option value="@{flag.asString}" @{if(flag == selectedFlag) "selected"}>
                                @flag.displayString
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="teamName">Team:</label>
                    <select class="form-control" id="teamName" name="teamName">
                        <option value="" @{if(selectedTeam.isEmpty) "selected"}>All</option>
                        @teams.map { team =>
                            <option value="@{team.name.asString}" @{if(Some(team) == selectedTeam) "selected"}>
                                @team.name.asString
                            </option>
                        }
                    </select>
                </div>
            </div>
        </form>
    </div>
    <div>
        <table class="table table-striped" id="jdk-table">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Vendor</th>
                    <th>JDK Version</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                @jdkVersions.map(jdkVersion)
            </tbody>
        </table>

    </div>

    <script @CSPNonce.attr type="text/javascript">
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.setOnLoadCallback(drawAll);

        function drawAll() {
            drawChart();
            drawVendorChart()
        }

        // draw jdk version chart
        function drawChart() {

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Version');
            data.addColumn('number', 'Count');
            data.addRows([
                @for(r <- jdkVersions.groupBy(v => s"${v.version} ${v.vendor}").mapValues(_.length).toList.sortBy( _._1.replaceAll("\\D", "").toInt)) {
                ['@r._1', @r._2],
                }
            ]);

            var options = {
                'width'    : "40%",
                'height'   : 200,
                'chartArea': {
                    'width': '100%',
                    'height': '95%'
                }
            };
            var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        }

        function drawVendorChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Version');
            data.addColumn('number', 'Count');
            data.addRows([
                @for(r <- jdkVersions.groupBy(j => j.vendor.toString + "(" + j.kind + ")").mapValues(_.length)) {
                ['@r._1', @r._2],
                }
            ].sort());

            var options = {
                'width'    : "40%",
                'height'   : 200,
                'chartArea': {
                    'width': '100%',
                    'height': '95%'
                }
            };
            var chart = new google.visualization.PieChart(document.getElementById('chart_vendor_div'));
            chart.draw(data, options);
        }
    </script>
    <script @CSPNonce.attr>
      ["teamName", "flag"]
        .forEach(function(id) {
          document.getElementById(id).addEventListener("change", function() {
            document.getElementById("form").submit();
          });
        });
    </script>
}

@jdkVersion(version: JDKVersion) = {
    <tr id="jdk-slug-@version.name">
        <td><a href="@appRoutes.CatalogueController.repository(version.name)">@version.name</a></td>
        <td>
          @version.vendor match {
            case Oracle  => { <img src="@routes.Assets.versioned("img/oracle2.gif")" width="70px" alt="Oracle" /> }
            case OpenJDK => { <img src="@routes.Assets.versioned("img/openjdk.png")" width="70px" alt="OpenJDK"/> }
          }
        </td>
        <td>@version.version</td>
        <td>@version.kind</td>
    </tr>
}
