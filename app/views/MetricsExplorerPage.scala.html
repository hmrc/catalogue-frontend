@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.mvc.Call
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.connector.model.{BobbyVersion, DependencyScope, GroupArtefacts, ServiceWithDependency, TeamName}
@import uk.gov.hmrc.cataloguefrontend.model.SlugInfoFlag
@import uk.gov.hmrc.cataloguefrontend.MetricsExplorerController
@import uk.gov.hmrc.cataloguefrontend.DependencyExplorerController.PieData
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.{ routes => appRoutes }
@import uk.gov.hmrc.cataloguefrontend.service.SearchByUrlService.FrontendRoutes
@import play.twirl.api.Html

@this(viewMessages: ViewMessages)

@(form            : Form[_],
  teams           : Seq[TeamName],
  flags           : Seq[SlugInfoFlag],
  scopes          : Seq[DependencyScope],
  groupArtefacts  : List[GroupArtefacts],
  searchResults   : Option[Seq[ServiceWithDependency]],
  pieData         : Option[PieData])(
  implicit request         : Request[_],
           messagesProvider: MessagesProvider)

@standard_layout("Metrics Explorer", "search") {
    <html>
    <head>
        <style>
        .grid-container {
          display: grid;
          grid-template-columns: auto auto auto auto auto auto;
          padding: 10px;
        }
        .grid-item {
          padding: 20px;
          font-size: 30px;
          text-align: center;
        }
        </style>
    </head>

    <header>
        <h1 id="search-service-header">Metrics Explorer</h1>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </header>

    <div id="service-list">

        @if(form.hasGlobalErrors) {
            <div class="alert alert-error error">
                <a class="close" data-dismiss="alert">Ã—</a>
                <ul>
                    @form.globalErrors.map { error =>
                        <li>@error.format</li>
                    }
                </ul>
            </div>
        }

        <div class="board">
            <div class="board__body">
                @helper.form(
                    action =  appRoutes.MetricsExplorerController.search,
                    'class -> "form-inline",
                    'id    -> "search-by-dependency-form") {
                    <table class="padded-table">
                        <tr>
                            <td style="vertical-align: top;">
                                @helper.select(
                                    form("group"),
                                    helper.options(Seq("" -> Messages("dependencyexplorer.select.group")) ++
                                                   groupArtefacts.map(_.group).map(g => (g, g)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                                @helper.select(
                                    form("artefact"),
                                    helper.options(List()),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                        </tr>
                        <tr>
                            <td>
                                @helper.select(
                                    form("team"),
                                    helper.options(Seq("" -> Messages("dependencyexplorer.select.teams.all")) ++
                                                   teams.map(_.asString).map(t => (t, t)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                                @helper.select(
                                    form("flag"),
                                    helper.options(flags.map(t => (t.asString, t.displayString)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                                @helper.select(
                                    form("scope"),
                                    helper.options(scopes.map(t => (t.asString, t.displayString)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                            <td valign="bottom">
                                <button id="search-button" class="btn btn-primary" type="submit">Search</button>
                            </td>
                        </tr>

                        </table>
                     </div>
                }
                @searchResults match {
                    case None                => {
                        <ul class="list"/>
                    }
                    case Some(Nil)           => {
                        <p id="search-results-empty">This search did not return any results.</p>
                        <ul class="list"/>
                    }
                    case Some(searchResults) => {
                        <p>Found @searchResults.size results</p>

                        <div id="chart_div" align="center" class="grid-container"></div>
            }
                }
            </div>
        </div>
    </div>

    <script>
        if (document.readyState != 'loading'){
            ready();
        } else {
            document.addEventListener('DOMContentLoaded', ready);
        }

        function ready() {
            document.getElementById("group").onchange = updateArtefacts;
            updateArtefacts();
            updateSortOrder();
        }

        var options = { valueNames: [ 'service', 'teams', 'dep-version' ] };
        var serviceList = null;

        function updateSortOrder() {
            serviceList = new List('service-list', options);
        }

        function updateArtefacts() {
            var group = document.getElementById("group").value;

            var groupArtefacts = {
                @groupArtefacts.map { res =>
                '@{res.group}': [@for(a <- res.artefacts){
                    '@a',
                    }]
                ,
                }
            }

            var artefactSelect = document.getElementById("artefact")
            while (artefactSelect.options.length > 0) {
                artefactSelect.remove(artefactSelect.options.length - 1);
            }

            var artefacts = groupArtefacts[group];
            if (artefacts) {
                var opt = document.createElement('option');
                opt.text = "@Messages("dependencyexplorer.select.artefact")";
                opt.value = "";
                artefactSelect.add(opt, null);
                for (i = 0; i < artefacts.length; i++)
                {
                    var opt = document.createElement('option');
                    opt.text = artefacts[i];
                    opt.value = artefacts[i];
                    opt.selected = artefacts[i] == '@{form("artefact").value}';
                    artefactSelect.add(opt, null);
                }
            }
        }
    </script>

    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        const chartDiv = document.getElementById('chart_div');

        function drawChart() {

            @pieData match {
                case None => {}
                case Some(pd) => {
                    var options = {
                                    'height'   : 150,
                                    'width'   : 150,
                                    'colors': ['green', 'Red'],
                                    'chartArea': { 'width': '100%', 'height': '100%'},
                                    'legend': 'none'
                                  };


                    const arr = ["foo", "bar", "baz", "qux", "quuuuuuuuuuux", "quuz", "corge", "grault", "garply", "waldo", "fred", "plugh", "xyzzy", "thud"].map(x => [x, Math.floor(Math.random() * 100)]);
                    arr.forEach( ([key, value]) => {
                        let container = chartDiv.appendChild(document.createElement('grid-item'));

                        <!--drawing pie chart-->
                        let data = new google.visualization.DataTable();
                        data.addColumn('string', 'Version');
                        data.addColumn('number', 'Count');
                        data.addRows([["Happy", value], ["Unhappy", 100-value]]);
                        let chart = new google.visualization.PieChart(container);
                        chart.draw(data, options);

                        <!--manual caption for the charts-->
                        let p = document.createElement("p");
                        let h2Element = document.createElement('h3');
                        h2Element.innerText = key;
                        p.appendChild(h2Element);
                        container.appendChild(p);
                    })
                }
            }
        }
    </script>
}
    </html>
<!--todo: remove this?-->
@selected(optVersion: Option[BobbyVersion]) = {
    @optVersion.map(v => if (v.inclusive) "selected" else "").getOrElse("selected")
}
