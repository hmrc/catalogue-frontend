@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.connector.model.TeamName
@import uk.gov.hmrc.cataloguefrontend.users.User
@import uk.gov.hmrc.cataloguefrontend.users.UsersListFilter
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.users.UsersController.maxRows
@import views.html.helper.select

@this()

@(
  users    : Seq[User],
  teams    : Seq[Team],
  form     : Form[UsersListFilter],
)(implicit
  messages: Messages,
  request : RequestHeader
)

@standard_layout("Users", "users") {
  <header>
    <h1>Users</h1>
  </header>
  <div id="users-list">
    <form id="form" action="/users" method="get">
      <div id="users-form-row" class="form-group row">
        <div class="col-md-6">
          <label for="search">Username or GitHub</label>
          <input class="search form-control" type="text" id="username-search" name="username" value="@form("username").value" autofocus>

        </div>
        <div class="col-md-offset-6">
        @select(
          field               = form("team"),
          options             = teams.map(t => t.name.asString -> t.name.asString),
          Symbol("_default") -> "All",
          Symbol("_label")   -> "Team",
          Symbol("id")       -> "team-filter",
          Symbol("class")    -> "form-control"
        )
        </div>
      </div>
    </form>

    <table class="table table-striped sticky-header" id="users-table">
      <thead id="user-table-headings">
        <tr>
          <td colspan="6">
            <span class="col-md-offset-4" id="maximum-records" style="color: #6f777b;">Only displaying @maxRows records - please refine your search</span>
          </td>
        </tr>
        <tr>
          <th class="col-lg-2"><button role="button" id="username" data-sort="username" class="sort no-border username">Username</button></th>
          <th class="col-lg-2"><button role="button" id="givenName" data-sort="given-name" class="sort no-border">Given Name</button></th>
          <th class="col-lg-2"><button role="button" id="familyName" data-sort="family-name" class="sort no-border">Family Name</button></th>
          <th class="col-lg-3"><button role="button" id="github" data-sort="github" class="sort no-border">GitHub</button></th>
          <th class="col-lg-3">Teams</th>
        </tr>
      </thead>

      <tbody class="list">
        @users.zipWithIndex.map{ case(user, i) =>
        <tr id="row@i">
          <td class="username" id="row@{i}_name">
            <a class="ldap-username" href="/users/@user.username">@user.username</a>
          </td>


          <td class="given-name" id="row@{i}_teams">
            @user.givenName
          </td>

          <td class="family-name" id="row@{i}_teams">
            @user.familyName
          </td>

          <td class="github" id="row@{i}_name">
            @user.githubUsername match {
              case Some(url) => {
                  <a class="github-username" href="https://github.com/@user.githubUsername" target="_blank" rel="noreferrer noopener">
                    @user.githubUsername
                    <span class="glyphicon glyphicon-new-window"/>
                  </a>
              }
              case None => {}
            }
          </td>

          <td class="" id="row@{i}_teams">
            @user.teamsAndRoles.map { optTeams =>
              @optTeams.map { team =>
                <div>
                  <a href="/teams/@TeamName(team.teamName).asString">@TeamName(team.teamName).asString</a>
                  @if(team.role == "team_admin") {
                    <span class="badge" style="font-weight: bold">@team.role</span>
                  }
                </div>
              }
            }
          </td>
        </tr>
        }
      </tbody>
    </table>
    <div id="no-users-found">
      <span class="col-md-offset-5" style="color: #6f777b;">No Users Found</span>
    </div>
  </div>
}
<!-- listjs configuration -->
<script @CSPNonce.attr>
  function toggleMessage() {
    const emptyRows = 2;
    const rows = document.getElementById('users-table').rows.length;
    const noUsersFound = document.getElementById('no-users-found');
    const maxRecords = document.querySelector('#maximum-records');

    if (noUsersFound) {
      noUsersFound.style.display = rows === emptyRows ? 'block' : 'none';
    }

    if (maxRecords) {
      maxRecords.style.display = rows >= @maxRows + emptyRows ? 'block' : 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', toggleMessage);

  const options = {
    valueNames: ['username', 'given-name', 'family-name', 'github', 'github-username', 'ldap-username'],
    searchColumns: ['ldap-username', 'github-username'],
    searchDelay: 350,
    page: @maxRows,
  };

  const usersList = new List('users-list', options)
  usersList.on('searchComplete', toggleMessage);

  const searchBox = document.getElementById('username-search');
  searchBox.addEventListener('change', () => usersList.search(searchBox.value));
  searchBox.focus();

  const queryParams = new URLSearchParams(window.location.search);
  const usernameParam = queryParams.get('username');
  if (usernameParam) {
    searchBox.value = usernameParam;
    usersList.search(usernameParam);
  }
</script>


<script @CSPNonce.attr>
  document.getElementById('team-filter').addEventListener('change', function () {
  document.getElementById('form').submit();
  });
</script>

