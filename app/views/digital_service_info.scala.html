@*
* Copyright 2016 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@
@import uk.gov.hmrc.cataloguefrontend.RepoType.RepoType
@import uk.gov.hmrc.cataloguefrontend.TeamsAndRepositoriesConnector.{ConnectionError, HTTPError, TeamsAndRepositoriesError}
@import uk.gov.hmrc.cataloguefrontend.UserManagementConnector.{NoData, UMPError}
@import uk.gov.hmrc.cataloguefrontend.{DigitalServiceDetails, RepoType, Timestamped, ViewMessages}
@(digitalServiceName: String, timestampedRepos: Either[TeamsAndRepositoriesError, Timestamped[DigitalServiceDetails]], digitalServiceOwner: Option[String] )(implicit messages: Messages)

@standard_layout(digitalServiceName, "digital-services") {
    <header>
        <h1>Digital Service: @digitalServiceName</h1>
        <time class="last-updated">Last updated at: @{timestampedRepos.right.map(_.formattedTimestamp).right.getOrElse("Not Available")}</time>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </header>

    

    <div class="row">
        <div class="col-md-12">
            <div class="board">
                <h3 class="board__heading">Details</h3>
                <div class="board__body">
                    <div class="col-lg-7 editable-label">
                        <label >Service Owner: </label>
                        <span id="service_owner_edit_component" style="display: None">
                            <div class="input-group">
                                <input type="text" id="service_owner_edit_input" class="form-control" value="@{digitalServiceOwner.getOrElse("Not specified")}">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-primary" onclick="saveServiceOwner()">
                                        <span aria-hidden="true"></span> Save
                                    </button>
                                    <button type="button" class="btn" onclick="endServiceOwnerEditMode()">
                                        <span aria-hidden="true"></span> Cancel
                                    </button>
                                </div>
                            </div>
                            <div id="service-owner-error" class="alert alert-danger" style="display: none"></div>
                        </span>
                        <span id="service_owner_view_component" class="service-owner-view" >
                            <div class="input-group">
                                <span id="service_owner_view_field" class="form-control editable-label__field">@{ digitalServiceOwner.getOrElse("Not specified")}</span>
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-primary" onclick="enterServiceOwnerEditMode()">
                                        <span aria-hidden="true"></span> Edit
                                    </button>
                                </div>
                            </div>
                        </span>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    @if(timestampedRepos.isRight) {
        @for(timestampedDigitalService <- timestampedRepos.right.toOption) {

            <div class="row">
                <div class="col-md-12">
                    <div class="board">
                        <h3 class="board__heading">Contributing Teams</h3>
                        @for((teamName, errorOrMembers) <- timestampedDigitalService.data.teamMembersLookUp) {
                           <h4 class="sub__heading"><a href="/teams/@teamName">@teamName</a></h4>

                           <div class="board__body">
                               <div>
                                   <ul class="list list--minimal" id="team_members">
                                   @if(errorOrMembers.isRight) {
                                       @for(teamMember <- errorOrMembers.right.get) {
                                           <li class="col-xs-3">
                                               <a href="@teamMember.umpLink" target="_blank">@teamMember.displayName</a>
                                           </li>
                                       }

                                   } else {
                                       <li class="list list--minimal" id="ump-error-@{teamName}">
                                       @showUmpError(errorOrMembers.left.get, teamName)
                                       </li>
                                   }
                                   </ul>

                               </div>

                           </div>
                        }
                    </div>
                </div>
            </div>

            <section class="section-wrapper">
                <div class="row">

                    @showRepositories(timestampedDigitalService.data.repos, RepoType.Service, "Services", "service", "service")
                    @showRepositories(timestampedDigitalService.data.repos, RepoType.Library, "Libraries", "library", "library")
                    @showRepositories(timestampedDigitalService.data.repos, RepoType.Prototype, "Prototypes", "prototype", "prototype")
                    @showRepositories(timestampedDigitalService.data.repos, RepoType.Other, "Repositories", "other", "repositories")

                </div>
            </section>

        }


    } else {
        <div id="teams-and-repositories-error" class="row">
            @showTeamsAndRepositoriesError(timestampedRepos.left.get, digitalServiceName)
        </div>
    }

    <script>
        function hideErrors(){
            $('#service-owner-error').hide();
        }

        function enterServiceOwnerEditMode() {
            hideErrors();

            var currentServiceOwnerValue = $('#service_owner_view_field').text();
            if(currentServiceOwnerValue === 'Not specified') {
                currentServiceOwnerValue = '';
            }
            $('#service_owner_edit_input').val(currentServiceOwnerValue);

            $('#service_owner_edit_component').show();
            $('#service_owner_view_component').hide();
        }

        function endServiceOwnerEditMode() {
            $('#service_owner_view_component').show();
            $('#service_owner_edit_component').hide();
        }


        $(function() {
            $( '#service_owner_edit_input').autocomplete({
                source: "/users",
                autoFocus: true,
                minLength: 3,
                select: function() {
                    hideErrors();
                }
            });
        });

        function saveServiceOwner() {
            var digitalServiceOwnerName = $('#service_owner_edit_input').val();
            var data = {
                service: "@digitalServiceName",
                name: digitalServiceOwnerName
            };

            $.ajax({
                url: 'owner',
                type: 'post',
                dataType: 'json',
                headers: { 'Content-Type': 'application/json' },
                data: JSON.stringify(data),
                success: function(result,status,xhr){
                    $("#service_owner_view_field").text(result);
                    endServiceOwnerEditMode();
                },
                error: function(xhr,status,error){
                    debugger;
                    $("#service-owner-error").show().text(xhr.responseJSON);
                }
            });


        }



    </script>

}

@showUmpError(error: UMPError, teamName: String) = {
@error match {
    case NoData(linkToRectify) => {
        @teamName is unknown to the User Management Portal. To add the team, please raise a TSR
    }
    case _ => {
        Sorry, the User Management Portal is not available
    }
}
}
@showTeamsAndRepositoriesError(error: TeamsAndRepositoriesError, digitalServiceName: String) = {
@error match {
    case HTTPError(errorCode) => {
        An HTTP error occurred while retrieving digital service (@digitalServiceName): @errorCode
    }
    case ConnectionError(e) => {
        A connection error to the teams-and-repositories microservice occurred while retrieving digital service (@digitalServiceName)
    }
}
}


@showRepositories(repos: Map[String, Seq[String]], repoType: RepoType, headerName: String, typeName: String, href: String) = {
    @repos.get(repoType.toString).map { repositories =>
        <div class="col-md-3">
            <div class="board">
                <h3 class="board__heading">@headerName</h3>

                <div class="board__body">
                    @if(repositories.isEmpty) {
                        <p>@Html(ViewMessages.noRepoOfTypeForDigitalService(typeName))</p>

                    } else {
                        <ul class="list list--minimal">
                        @for(repository <- repositories) {
                            <li class="list-item" id="@{
                                repository
                            }"><a href="/@href/@{
                                repository
                            }">@repository</a>
                            </li>
                        }
                        </ul>
                    }
                </div>
            </div>
        </div>
    }
}
