@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import partials.DependenciesByEnvironmentPartial
@import play.twirl.api.Html
@import uk.gov.hmrc.cataloguefrontend.connector.GitRepository
@import uk.gov.hmrc.cataloguefrontend.model.{Environment, SlugInfoFlag}
@import uk.gov.hmrc.cataloguefrontend.prcommenter.PrCommenterReport
@import uk.gov.hmrc.cataloguefrontend.service.RouteRulesService.ServiceRoutes
@import uk.gov.hmrc.cataloguefrontend.service.CostEstimationService.ServiceCostEstimate
@import uk.gov.hmrc.cataloguefrontend.service.CostEstimateConfig
@import uk.gov.hmrc.cataloguefrontend.serviceconfigs.ServiceConfigsService
@import uk.gov.hmrc.cataloguefrontend.EnableBranchProtection
@import uk.gov.hmrc.cataloguefrontend.{EnvData, ViewMessages}
@import views.partials.githubBadgeType
@import java.time.Instant

@this(
  dependenciesByEnvironmentPartial: DependenciesByEnvironmentPartial,
  viewMessages                    : ViewMessages
)

@(serviceName                  : String,
  repositoryDetails            : GitRepository,
  costEstimate                 : ServiceCostEstimate,
  costEstimateConfig           : CostEstimateConfig,
  repositoryCreationDate       : Instant,
  envDatas                     : Map[SlugInfoFlag, EnvData],
  linkToLeakDetection          : Option[String],
  serviceRoutes                : ServiceRoutes,
  hasBranchProtectionAuth      : EnableBranchProtection.HasAuthorisation,
  commenterReport              : Option[PrCommenterReport],
  distinctVulnerabilitiesCount : Option[Int],
  serviceRelationships         : ServiceConfigsService.ServiceRelationshipsWithHasRepo
)(implicit
  messages                     : Messages,
  request                      : RequestHeader
)


@standard_layout(serviceName, "services") {
    <header class="header-with-github-badge">
        <div>
            <h1 id="service-header">
              Service: @serviceName
              <span>@githubBadgeType(repositoryDetails)</span>
                  @if(repositoryDetails.isDeprecated) { <span>Deprecated</span> }
                  @if(repositoryDetails.isArchived) { <span>Archived</span> }
            </h1>
            <button id="service-info-tour" class="btn btn-default pull-right">Take a tour!</button>
        </div>

        <script @CSPNonce.attr type="text/javascript" src="@routes.Assets.versioned("charts-loader-51.js")"></script>
    </header>

    <div id="service-warnings">
        @partials.leak_detection_banner(linkToLeakDetection)
        @defining(envDatas.get(SlugInfoFlag.ForEnvironment(Environment.Production)).toSeq.flatMap(_.repoModules).flatMap(_.allDependencies)){ dependencies =>
          @partials.bobby_violations_banner(environment = Some(Environment.Production), dependencies = dependencies, pending = false)
          @partials.bobby_violations_banner(environment = Some(Environment.Production), dependencies = dependencies, pending = true )
        }
    </div>

    <section class="section-wrapper">

        <div class="row">
            <div class="col-md-6">
                @partials.details(repositoryDetails)
            </div>
            <div class="col-md-6">
                @partials.costEstimation(costEstimate, costEstimateConfig, serviceName, linkToCostsPage = true)
            </div>
        </div>

        @serviceRoutes.environmentRoutes.find(er => er.environment == "production" && !er.isAdmin).map { envRoute =>
            <div class="row">
                <div class="col-md-12">
                    @partials.serviceUrlDetails(envRoute, isAdmin = false)
                </div>
            </div>
        }

        @serviceRoutes.environmentRoutes.find(er => er.environment == "production" && er.isAdmin).map { envRoute =>
            <div class="row">
                <div class="col-md-12">
                    @partials.serviceUrlDetails(envRoute, isAdmin = true)
                </div>
            </div>
        }

        @if(serviceRoutes.hasInconsistentRoutes) {
            <div class="row">
                <div class="col-md-12">
                    @partials.serviceRouteRuleViolations(serviceRoutes)
                </div>
            </div>
        }

        <div class="row">
            <div class="col-md-6">
                @partials.repo_owning_teams(repositoryDetails)
            </div>

            <div class="col-md-6">
                @partials.code(repositoryDetails, hasBranchProtectionAuth, commenterReport, distinctVulnerabilitiesCount)
            </div>
            <div class="col-md-6">
                @partials.service_relationships(serviceRelationships)
            </div>
            <div class="col-md-6">
                @partials.build(repositoryDetails, hasBranchProtectionAuth, commenterReport)
            </div>
        </div>

        @dependenciesByEnvironmentPartial(serviceName, envDatas)
    </section>

    <div class="alert alert-success" role="alert" id="@repositoryDetails.name">
        <p>
          @Html(viewMessages.informationalText)
        </p>
    </div>

    @* ----- Tour ----- *@
    <script @CSPNonce.attr src="@routes.Assets.versioned("bootstrap-tourist.js")"></script>
    <link rel="stylesheet" href="@routes.Assets.versioned("bootstrap-tourist.css")" />

    <script @CSPNonce.attr>
        let tourSteps = [
            {
                element   : "#service-warnings",
                title     : "Service Warnings",
                content   : "Here you can see any warnings relating to your Service. These include warnings from Leak Detection and Bobby Rules.",
                placement : "bottom"
            },
            {
                element   : "#cost-estimation",
                title     : "Cost Estimation",
                content   : "Here you can see an estimation of how much it costs to run the service across all environments per year.",
                placement : "left"
            },
            {
                element   : "#service-urls-section",
                title     : "Frontend Routing Configuration",
                content   : "Here you can see the URL path of the service.",
                placement : "bottom"
            },
            {
                element   : "#owning-team",
                title     : "Teams",
                content   : "Here you can see the service's Owning Team(s).",
                placement : "right"
            },
            {
                element   : "#code",
                title     : "Code",
                content   : "Here you can see the branch protection status of the repository, as well as a link to the GitHub repository. There are also links to other parts of the Catalogue, each covering different aspects of the service - take some time to explore.",
                placement : "left"
            },
            {
                element   : "#service_relationships",
                title     : "Service Relationships",
                content   : "Here you can see the service's relationships with other services. 'Inbound' are services that are configured to call this service, and 'Outbound' are the services that this service is configured to call.",
                placement : "right"
            },
            {
                element   : "#builds",
                title     : "Builds",
                content   : "Here you can see the build jobs associated with this service as well as the latest result from the build.",
                placement : "left"
            },
            {
                element   : "#environmentTabs",
                title     : "Environments",
                content   : "Here you can see which version of the service is deployed in each environment. Clicking the tabs will display the dependencies for that version of the service as well as the plugins. This is a useful tool for seeing how up to date the service's dependencies are.",
                placement : "top"
            }
        ];

        // remove any steps where the element isn't shown or is empty
        let filteredSteps = tourSteps.filter( function(step) {
            return $(step.element).length > 0 && $(step.element).html().trim().length > 0;
        });

        let tour = new Tour({
            framework: "bootstrap3",
            steps: filteredSteps
        });

        document.getElementById('service-info-tour').addEventListener("click", function() {
            tour.restart()
        });
    </script>
}
