@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.mvc.Call
@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.connector.GitRepository
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.RepoType
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.CatalogueFrontendSwitches
@import helper._

@this(viewMessages: ViewMessages)

@(repositories: Seq[GitRepository],
  teams: Seq[Team],
  form: Form[_]
)(implicit messages: Messages, request: Request[_])

@standard_layout("Repositories", "repositories") {
    <header>
        <h1>Repositories</h1>
    </header>

    @if(form.hasErrors) {
        <div class="alert alert-danger" role="alert">
        <ul class="list">
            @form.errors.map { error =>
              <li class="alert-danger"> @Messages(error.message, error.args: _*)</li>
            }
        </ul>
    </div>
    }

    <div id="service-list">
        <form action="/repositories" method="get">
            <div class="form-group row">
                <div class="col-md-5">
                    <label for="search">Name</label>
                    <input class="search form-control" id="search" type="text" name="name" value='@form("name").value' autofocus>
                </div>
                <div class="col-md-3">
                    @select(
                    field      = form("team"),
                    options    = teams.map(t => t.name.asString -> t.name.asString),
                    '_default -> "All",
                    '_label   -> "Team",
                    'onchange -> "this.form.submit()",
                    'id       -> "team-filter",
                    'class   -> "form-control"
                    )
                </div>
                <div class="col-md-3">
                    @select(
                    field       =  form("repoType"),
                    options     =  Seq(
                                     "Library"   -> "Library",
                                     "Prototype" -> "Prototype",
                                     "Service"   -> "Service",
                                     "Other"     -> "Other"
                                   ),
                    '_default -> "All",
                    '_label   -> "Type",
                    'onchange -> "this.form.submit()",
                    'id       -> "type-search",
                    'class   -> "form-control"
                    )
                </div>
            </div>
        </form>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="col-lg-3"><button role="button" class="sort no-border" data-sort="repo-name">Name</button></th>
                    <th class="col-lg-1"><button role="button" class="sort no-border" data-sort="repo-status">Status</button></th>
                    <th class="col-lg-1"><button role="button" class="sort no-border" data-sort="repo-type">Type</button></th>
                    <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="repo-team">Team</button></th>
                    @if(CatalogueFrontendSwitches.branchProtectionDisplay.isEnabled) {
                    <th class="col-lg-1"><button role="button" class="sort no-border" data-sort="repo-bp">Branch Protection</button></th>
                    }
                    <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="created">First Active</button></th>
                    <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="last-active">Last Active</button></th>
                </tr>
            </thead>
            <tbody class="list">
            @repositories.zipWithIndex.map{case (repo, i) =>
            <tr id="row@i">
                <td class="repo-name" id="row@{i}_name">
                    <a class="@if(repo.isDeprecated || repo.isArchived){deprecated} @if(repo.isArchived){archived}" href="@uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.repository(repo.name)">@repo.name</a>
                </td>

                <td class="" id="row@{i}_repostatus">

                    @if(repo.isArchived) {
                        <span class="repo-status badge">archived</span>
                    } else {
                        @if(repo.isDeprecated) { <span class="repo-status badge badge-warning">deprecated</span> }
                    }

                </td>

                <td class="repo-type monospaced" id="row@{i}_repotype">
                    @repo.repoType.asString
                </td>
                <td id="row@{i}_team">
                @if(repo.teamNames.length <= 4) {
                    @repo.teamNames.take(4).map {tn => <div  class="repo-team" >@tn</div> }
                } else {
                    <div title="@repo.teamNames.take(15).mkString("\n")" class="repo-team" >
                        <em>Shared by @{repo.teamNames.length} teams</em>
                    </div>
                }
                </td>
                @if(CatalogueFrontendSwitches.branchProtectionDisplay.isEnabled) {
                  <td class="repo-bp monospaced" id="row@{i}_branch-protection">
                      @if(repo.branchProtection.exists(_.isProtected)) {
                        <span class="glyphicon glyphicon-ok text-success"></span>
                        <span class="sr-only">Branch protection is enabled</span>
                      } else {
                        <abbr style="text-decoration: none; border-bottom: none;" title="@List(
                          s"Requires approving reviews = ${repo.branchProtection.exists(_.requiresApprovingReviews)}",
                          s"Dismisses stale reviews = ${repo.branchProtection.exists(_.dismissesStaleReviews)}",
                          s"Requires commit signatures = ${repo.branchProtection.exists(_.requiresCommitSignatures)}"
                        ).mkString("\n")">
                         <span class="glyphicon glyphicon-remove text-danger"></span>
                        </abbr>
                      <span class="sr-only">Branch protection is not enabled</span>
                      }
                  </td>
                }
                <td class="created monospaced" id="row@{i}_created">
                    @repo.createdDate.asPattern(`yyyy-MM-dd`)
                </td>
                <td class="last-active monospaced" id="row@{i}_lastActive">
                    @repo.lastActiveDate.asPattern(`yyyy-MM-dd`)
                </td>
            </tr>
            }
            </tbody>
        </table>
    </div>
}

<!-- listjs configuration -->
<script>
    var options = { valueNames: [ 'repo-name', 'repo-status', 'repo-type', 'repo-team', 'repo-bp', 'created', 'last-active' ],
                    searchColumns: ['repo-name'] };

    var serviceList = new List('service-list', options);
</script>

@repoTypes = @{
    ("" ,"All") +: RepoType.values.map(v => (v.asString, v.asString)).toList
}
