@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.connector.RepositoryDisplayDetails
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import helper._

@this(viewMessages: ViewMessages)

@(repositories   : Seq[RepositoryDisplayDetails],
  teams          : Seq[String],
  singleOwnership: Boolean,
  includeArchived: Boolean,
  form           : Form[_]
)(implicit
  messages       : Messages,
  request        : Request[_]
)

@standard_layout(s"Default Branches", "defaultbranch") {
<header>
    <h1>Default Branch Naming Progress</h1>
</header>

@if(form.hasErrors) {
<div class="alert alert-danger" role="alert">
    <ul class="list">
        @form.errors.map { error =>
        <li class="alert-danger"> @Messages(error.message, error.args: _*)</li>
        }
    </ul>
</div>
}

<div id="default-branches">
    <form action="/defaultbranch" method="get">
        <div class="form-group row">
            <div class="col col-xs-3">
                <label for="search">Name:</label>
                <div>
                    <input class="form-control" id="search" type="text" name="name" value='@form("name").value'>
                </div>
            </div>
            <div class="col col-xs-3" style="padding-left: 15px; padding-right: 15px;">
                @select(
                field = form("teamNames"),
                options = teams.map(t => t -> t),
                '_default -> "All",
                '_label -> "Teams: ",
                'name -> "teamNames",
                'value -> "form('teamNames').value",
                'id -> "teamNames"
                )
                <div>
                    Single ownership
                    <input class="checkbox" id="singleOwnership" name="singleOwnership" type="checkbox" data-toggle="tooltip" title="Return repositories that are owned solely by the selected team." value="true" @if(singleOwnership){checked}>
                </div>
            </div>
            <div class="col-xs-3">
                <label for="defaultBranch">Branch:</label>
            <div>
                <input class="form-control" id="defaultBranch" type="text" name="defaultBranch" value='@form("defaultBranch").value'>
            </div>
            </div>
            <div style="float: right; ">
                <button class="btn btn-primary" type="submit" href="@uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.allDefaultBranches()">Search</button>
            </div>
        </div>
    </form>
    <table class="table table-striped">
        <div>
        @defining(repositories.filter(_.defaultBranch != "master").length) { nonMasterCount =>
        <td colspan="4"><progress class="progress" style="width: 100%;" id="nomenclature" max="@repositories.length" value='@nonMasterCount'> @@nonMasterCount </progress> </td>
            Updated default branch names: @nonMasterCount/@repositories.length
        }
        </div>
        <tr>
            <th class="col-lg-6"><button role="button" class="sort no-border" data-sort="repo-name">Name</button></th>
            <th class="col-lg-6"><button role="button" class="sort no-border" data-sort="teamNames">Team/s</button></th>
            <th class="col-lg-6"><button role="button" class="sort no-border" data-sort="defaultBranch">Default Branch</button></th>
            @if(includeArchived) {
                <th class="col-lg-6"><button role="button" class="sort no-border" data-sort="isArchived">Archived</button></th>
            }
        </tr>
        <tbody class="list">
        @repositories.zipWithIndex.map{case (repo, i) =>
        <tr id="row@i">
            <td class="service-name" id="row@{i}_name">
                <a class="repo-name" href="@uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.repository(repo.name)">@repo.name</a>
            </td>
            <td class="teamNames monospaced" id="row@{i}_teamNames">
                @if(repo.teamNames.length > 0 && repo.teamNames.length <= 10) {
                        @repo.teamNames.mkString(", ")
                    } else  {
                        <i title="@repo.teamNames.mkString(", ")">Various Teams</i>
                    }
            </td>
            <td class="defaultBranch monospaced" id="row@{i}_defaultBranch">
                @repo.defaultBranch
            </td>
            @if(includeArchived) {
            <td class="isArchived monospaced" id="row@{i}_isArchived">
                @repo.isArchived
            </td>
            }
        </tr>
        }
        </tbody>
    </table>
</div>
}

<script>
    var options = { valueNames: [ 'service-name', 'repo-name', 'teamNames', 'defaultBranch', 'isArchived'],
                    searchColumns: ['repo-name', 'teamNames', 'defaultBranch', 'isArchived'] };

    var serviceList = new List('default-branches', options);
</script>
