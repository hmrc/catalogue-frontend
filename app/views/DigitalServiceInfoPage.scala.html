@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.connector.UserManagementConnector.UMPError
@import uk.gov.hmrc.cataloguefrontend.connector.model.TeamName
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.RepoType
@import uk.gov.hmrc.cataloguefrontend.DisplayableTeamMember
@import uk.gov.hmrc.cataloguefrontend.actions.UmpVerifiedRequest
@import uk.gov.hmrc.cataloguefrontend.{ routes => appRoutes }

@this(viewMessages: ViewMessages)

@(digitalServiceName : String,
  teamMembersLookUp  : Map[TeamName, Either[UMPError, Seq[DisplayableTeamMember]]],
  repos              : Map[RepoType, Seq[String]],
  digitalServiceOwner: Option[DisplayableTeamMember]
)(implicit request: UmpVerifiedRequest[_])

@standard_layout(digitalServiceName, "digital-services") {
    <header>
        <h1>Digital Service: @{digitalServiceName}</h1>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </header>

    <div class="row">
        <div class="col-md-12">
            <div class="board">
                <h3 class="board__heading">Details</h3>
                <div class="board__body">
                    <div class="col-lg-6">
                        <label >Service Owner: </label>
                        <span id="service_owner_view_component" class="service-owner-view" >
                            @digitalServiceOwner.map { so =>
                                <a href="@{so.umpLink}" target="_blank" id="service_owner_view_field">@{so.displayName}<span class="glyphicon glyphicon-new-window"/></a>
                            }.getOrElse {
                                <span id="service_owner_view_field">
                                    @{viewMessages.notSpecifiedText}
                                </span>
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="board">
                <h3 class="board__heading">Contributing Teams</h3>
                @for((teamName, errorOrMembers) <- teamMembersLookUp) {
                   <h4 class="sub__heading"><a href="/teams/@teamName.asString">@teamName.asString</a></h4>

                   <div class="board__body">
                       <div>
                           <ul class="list list--minimal" id="team_members">
                           @errorOrMembers match {
                               case Right(members) if members.isEmpty => {
                                   <li class="list list--minimal" id="ump-error-@{teamName.asString}">
                                       @teamName.asString has no members
                                   </li>
                               }
                               case Right(members) => {
                                   @for(teamMember <- members) {
                                       <li class="col-xs-3">
                                           <a href="@teamMember.umpLink" target="_blank">@teamMember.displayName<span class="glyphicon glyphicon-new-window"/></a>
                                       </li>
                                   }
                               }
                               case Left(UMPError.UnknownTeam) => {
                                   <li class="list list--minimal" id="ump-error-@{teamName.asString}">
                                       @teamName.asString is unknown to the User Management Portal. To add the team, please raise a TSR
                                    </li>
                               }
                               case Left(_) => {
                                   <li class="list list--minimal" id="ump-error-@{teamName.asString}">
                                         Sorry, the User Management Portal is not available
                                   </li>
                               }
                           }
                           </ul>

                       </div>

                   </div>
                }
            </div>
        </div>
    </div>

    <section class="section-wrapper">
        <div class="row">
            @showRepositories(repos.getOrElse(RepoType.Service  , Seq.empty), "Services"    , "service")
            @showRepositories(repos.getOrElse(RepoType.Library  , Seq.empty), "Libraries"   , "library")
            @showRepositories(repos.getOrElse(RepoType.Prototype, Seq.empty), "Prototypes"  , "prototype")
            @showRepositories(repos.getOrElse(RepoType.Other    , Seq.empty), "Repositories", "other")

        </div>
    </section>
}

@showRepositories(repos: Seq[String], headerName: String, typeName: String) = {
  <div class="col-md-3">
    <div id="@headerName" class="board">
      <h3 class="board__heading">@headerName</h3>

      <div class="board__body">
        @if(repos.isEmpty) {
          <p>@Html(viewMessages.noRepoOfTypeForDigitalService(typeName))</p>
        } else {
          <ul class="list list--minimal">
            @for(repo <- repos) {
              <li class="list-item" id="@repo"><a href="@appRoutes.CatalogueController.repository(repo)">@repo</a></li>
            }
          </ul>
        }
      </div>
    </div>
  </div>
}
