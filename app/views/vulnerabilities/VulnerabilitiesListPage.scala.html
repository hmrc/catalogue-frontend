@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.vulnerabilities.VulnerabilitySummary
@import uk.gov.hmrc.cataloguefrontend.vulnerabilities.{CurationStatus, routes => appRoutes}
@import views.html.vulnerabilities.VulnerabilityDetails
@import views.html.helper.{form, select}

@this(viewMessages: ViewMessages)

@(summaries: Seq[VulnerabilitySummary],
  teams    : Seq[Team],
  form     : Form[_]
)(implicit
  messages : Messages,
  request  : RequestHeader
)

@standard_layout(s"Vulnerabilities") {
    <header>
        <h1>Vulnerabilities</h1>
    </header>
    <div id="vulnerabilities-list">
        <form id="vuln-form" action="/vulnerabilities" method="get">
            <div class="form-group row">
                <div class="col-md-2">
                    <label for="id-search">Vulnerability ID:</label>
                    <input class="form-control" id="id-search" type="text" name="vulnerability" value='@form("vulnerability").value' autofocus>
                </div>
                <div class="col-md-2">
                    <label for="component-search">Vulnerable Component:</label>
                    <input class="form-control" id="component-search" type="text" name="component" value='@form("component").value'>
                </div>
                <div class="col-md-3">
                    <label for="service-search">Service:</label>
                    <input class="form-control" id="service-search" type="text" name="service" value='@form("service").value'>
                </div>
                <div class="col-md-3">
                @select(
                    field              =  form("team"),
                    options            =  teams.map(t => t.name.asString -> t.name.asString),
                    Symbol("_default") -> "All",
                    Symbol("_label")   -> "Team:",
                    Symbol("id")       -> "team-filter",
                    Symbol("class")    -> "form-control"
                )
                </div>
                <div class="col-md-2">
                @select(
                    field              =  form("curationStatus"),
                    options            =  (""->"All") :: CurationStatus.values.map(cs => cs.asString -> cs.display),
                    Symbol("_label")   -> "Curation status:",
                    Symbol("id")       -> "curation-status-search",
                    Symbol("class")    -> "form-control"
                )
                </div>
                @*Hidden submit button required to allow form submission on an enter press,
                    when two search fields exist in the same form*@
                <input style="visibility: hidden;" type="submit" />
            </div>
        </form>
        @if(summaries.isEmpty) {
            No results found matching the search criteria.
        } else {
            <table style="word-break: break-word" class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th class="col-xs-2"><button class="sort no-border" data-sort="vuln-id">Vulnerability ID</button></th>
                        <th class="col-xs-2"><button class="no-border" data-sort="vulnerable-component-name">Vulnerable Component</button></th>
                        <th class="col-xs-4"><button class="no-border" data-sort="assessment">Assessment</button></th>
                        <th class="col-xs-2"><button class="sort no-border" data-sort="curation-status">Curation Status</button></th>
                        <th class="col-xs-1 text-right"><button class="sort no-border" data-sort="score">Score</button></th>
                        <th class="col-xs-1 text-right"><button class="sort no-border" data-sort="services">Services</button></th>
                    </tr>
                </thead>
                <tbody class="list">
                    @summaries.map(vulnerabilitiesSummary)
                </tbody>
            </table>
        }
    </div>

    @if(summaries.nonEmpty) {
      <script @CSPNonce.attr>
        var options = {
            valueNames: ['vuln-id', 'score', 'curation-status', 'services']
        };
        new List('vulnerabilities-list', options);
      </script>
    }
}

@vulnerabilitiesSummary(summary: VulnerabilitySummary) = {
    @defining(summary.distinctVulnerability.vulnerableComponentName.split("://")) { splitVulnerableComponent =>
        <tr>
            <td class="accordion-toggle collapsed hand-pointer " data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id"/>
            <td class="vuln-id hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id">@summary.distinctVulnerability.id</td>
            <td class="vulnerable-component-name hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id">@splitVulnerableComponent.lift(1).getOrElse(summary.distinctVulnerability.vulnerableComponentName)</td>
            <td class="assessment hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id">@summary.distinctVulnerability.assessment.getOrElse("")</td>
            <td class="curation-status hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id"><div>@summary.distinctVulnerability.curationStatus.map(_.display).getOrElse("")</div></td>
            <td class="score hand-pointer text-right" data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id">@summary.distinctVulnerability.score.getOrElse("")</td>
            <td class="services text-right hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@summary.distinctVulnerability.id" aria-controls="collapsible-area-@summary.distinctVulnerability.id"><div>@summary.occurrences.groupBy(_.service).size</div></td>
        </tr>
        <tr id="collapsible-area-@summary.distinctVulnerability.id" class="collapse">
            @*Provide hidden fields in collapsable element so that list.js sorting doesn't break when some rows are expanded*@
            <td colspan="7">
                <table>
                    <tbody class="list">
                        <tr>
                            <td class="hide vuln-id">@summary.distinctVulnerability.id</td>
                            <td class="hide vulnerable-component-name">@splitVulnerableComponent.lift(1).getOrElse(summary.distinctVulnerability.vulnerableComponentName)</td>
                            <td class="hide assessment">@summary.distinctVulnerability.assessment.getOrElse("")</td>
                            <td class="curation-status text-center hide"><div>@summary.distinctVulnerability.curationStatus.map(_.display).getOrElse("")</div></td>
                            <td class="hide score text-center">@summary.distinctVulnerability.score.getOrElse("")</td>
                            <td class="services text-center hide"><div>@summary.occurrences.groupBy(_.service).size</div></td>
                        </tr>
                        <tr>
                            <td colspan="6">
                                @VulnerabilityDetails(summary, splitVulnerableComponent.lift(0))
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    }
}

<script @CSPNonce.attr>
  ["team-filter", "curation-status-search"]
    .forEach(function(id) {
      document.getElementById(id).addEventListener("change", function() {
        document.getElementById("vuln-form").submit();
      });
    });
</script>
