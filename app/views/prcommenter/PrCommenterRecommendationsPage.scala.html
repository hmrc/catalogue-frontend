@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.prcommenter.PrCommenterReport
@import uk.gov.hmrc.cataloguefrontend.util.MarkdownLoader
@import uk.gov.hmrc.cataloguefrontend.connector.model.TeamName
@import views.html.helper.select
@import views.html.partials.TeamNames

@this(
  viewMessages       : ViewMessages,
  teamNames          : TeamNames
)

@(form        : Form[_],
  teams       : Seq[Team],
  reports     : Seq[PrCommenterReport],
  commentTypes: Set[String]
)(implicit
  messages    : Messages,
  request     : RequestHeader
)

@standard_layout("PR-Commenter Recommendations") {
  <header>
    <h1 id="search-service-header">PR-Commenter Recommendations</h1>
  </header>

  <div id="recommendations-list">
    <form id="form" method="get">
      <div class="form-group row">
        <div class="col-md-6">
          <label for="search">Name</label>
          <input class="search form-control" id="search" type="text" name="name" value='@form("name").value' autofocus>
        </div>
        <div class="col-md-3">
          @select(
            field              =  form("teamName"),
            options            =  teams.map(t => t.name.asString -> t.name.asString),
            Symbol("_default") ->  "All",
            Symbol("_label")   -> "Team",
            Symbol("id")       -> "team-dropdown",
            Symbol("class")    -> "form-control"
          )
        </div>
        <div class="col-md-3">
          @select(
            field              =  form("commentType"),
            options            =  commentTypes.map(x => x -> x).toSeq.sorted,
            Symbol("_default") ->  "All",
            Symbol("_label")   -> "Comment Type",
            Symbol("id")       -> "comment-type-dropdown",
            Symbol("class")    -> "form-control"
          )
        </div>
      </div>
    </form>

    @if(reports.nonEmpty) {
      <div class="text-right">
        <a id="expandLink" class="hand-pointer">expand all</a>
        <a id="collapseLink" class="hand-pointer hidden">collapse all</a>
      </div>
      <table class="table table-striped sticky-header">
        <thead>
          <tr>
            <th></th>
            <th class="col-lg-8"><button class="sort no-border" data-sort="name">Repo</button></th>
            <th class="col-lg-2"><button class="sort no-border" data-sort="teams">Teams</button></th>
            <th class="col-lg-1"><button class="sort no-border" data-sort="recommendations">Recommendations</button></th>
            <th class="col-lg-1"><button class="sort no-border" data-sort="lastrun">Last run</button></th>
          </tr>
        </thead>
        <tbody class="list">
          @reports.map { report =>
            <tr>
              <td @collapseAttr("accordion-toggle collapsed", report)></td>
              <td @collapseAttr("name", report)>@report.name</td>
              <td @collapseAttr("teams", report)>
                @* TODO: change the report model to use TeamName types instead of String, then this mapping can be removed *@
                @teamNames(report.teamNames.map(TeamName.apply), s"${uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.repository(report.name)}#teams")
              </td>
              <td @collapseAttr("recommendations text-center", report)>@report.comments.size</td>
              <td @collapseAttr("lastrun hide text-nowrap", report)>@report.created</td>
              <td @collapseAttr("lastrun-display text-nowrap", report)>@report.created.displayFormat</td>
            </tr>
            <tr id="collapsible-area-@report.name" class="collapse multi-collapse @if(report.comments.isEmpty) { hide }">
              <td class="hide name"><a href="@report.name">@report.name</a></td>
              <td class="hide teams">
                @* TODO: change the report model to use TeamName types instead of String, then this mapping can be removed *@
                @teamNames(report.teamNames.map(TeamName.apply), s"${uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.repository(report.name)}#teams")
              </td>
              <td class="hide recommendations">@report.comments.size<td>
              <td class="hide lastrun">@report.created</td>
              <td colspan="5" style="padding: 30px">
                <ul class="list">
                  @{report.comments.map {
                    case x if form("commentType").value == Some(x.commentType) =>
                      Html(s"""<li class="highlight-dotted">${MarkdownLoader.markdownFromString(x.message).getOrElse(s"Invalid markdown: ${x.message}")}</li>""")
                    case x =>
                      Html(s"""<li >${MarkdownLoader.markdownFromString(x.message).getOrElse(s"Invalid markdown: ${x.message}")}</li>""")
                  }}
                </ul>
              </td>
            </tr>
          }
        </tbody>
      </table>
      <script @CSPNonce.attr>
        var options = {
          searchDelay: 350,
          valueNames: ['name', 'teams', 'recommendations', 'lastrun'],
          searchColumns: ['name']
        }

        var rulesList = new List('recommendations-list', options)

        function toggleExpandAll() {
          document.getElementById("expandLink").classList.toggle("hidden")
          document.getElementById("collapseLink").classList.toggle("hidden")
          Array.from(document.getElementsByClassName("multi-collapse")).forEach(el => el.classList.toggle("collapse"))
        }

        rulesList.on('updated', function(list) {
          const arr = Array.from(document.getElementsByClassName("multi-collapse"))
          if (arr.length == 1 && arr[0].classList.contains("collapse")) {
            toggleExpandAll()
          }
        })

        var searchBox = document.getElementById('search');
        // set autofocus cursor to right of text in search box
        var length = searchBox.value.length;
        searchBox.focus();
        searchBox.setSelectionRange(length, length);
        // re-search the list upon page load.
        rulesList.search(searchBox.value);

        ["expandLink", "collapseLink"]
          .forEach(function(id) {
            document.getElementById(id).addEventListener("click", function() {
              toggleExpandAll();
            });
          });
      </script>
    </div>
  }
}
<script @CSPNonce.attr>
  ["team-dropdown", "comment-type-dropdown"]
    .forEach(function(id) {
      document.getElementById(id).addEventListener("change", function() {
        console.log("AS");
        document.getElementById("form").submit();
      });
    });
</script>

@collapseAttr(cssClasses: String, report: PrCommenterReport) = {
  @if(report.comments.nonEmpty) {
    class="@cssClasses hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@report.name" aria-expanded="false" aria-controls="collapsible-area-@report.name"
  } else {
    class="@cssClasses.replaceAll("accordion-toggle collapsed", "")"
  }
}

