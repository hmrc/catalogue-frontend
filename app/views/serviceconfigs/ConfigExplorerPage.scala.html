@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.{CatalogueFrontendSwitches, ViewMessages}
@import uk.gov.hmrc.cataloguefrontend.serviceconfigs.{ServiceConfigsService, routes => serviceConfigsRoutes }
@import uk.gov.hmrc.cataloguefrontend.util.UrlUtils
@import scala.collection.immutable.ListMap
@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.WhatsRunningWhereVersion

@this(viewMessages: ViewMessages)

@(serviceName: String,
  configByKey: ServiceConfigsService.ConfigByKey,
  deployments: List[WhatsRunningWhereVersion]
)(implicit
  request: RequestHeader
)

@findDeployment(env: ServiceConfigsService.ConfigEnvironment) = @{
    deployments.find(e => ServiceConfigsService.ConfigEnvironment.ForEnvironment(e.environment) == env)
}

@show(env: ServiceConfigsService.ConfigEnvironment) = @{
    env == ServiceConfigsService.ConfigEnvironment.Local || findDeployment(env).isDefined
}

<html>
    <head>
        <title>Config - @serviceName</title>
        <link rel="stylesheet" href="@routes.Assets.versioned("config-explorer.css")" />
        <script @CSPNonce.attr src="@routes.Assets.versioned("split.js")"></script>
        <script @CSPNonce.attr src="@routes.Assets.versioned("config-explorer.js")"></script>
    </head>
    <body class="hide-refconf-only">
        <header class="opaque">
            <h1 id="service-header">Config: @serviceName</h1>
            <i class="glyphicon glyphicon-question-sign help-icon"></i>
            <i class="glyphicon glyphicon-menu-hamburger menu-icon"></i>
        </header>
        <section>
            <div class="grid-container explorer-grid">
                <div class="grid-header">
                    <div id="header-0" class="grid-item sticky-column truncate-content" style="width:300px; text-indent: 1.2em">Key</div>
                    <div class="gutter gutter-horizontal"></div>
                    @for((env, index) <- ServiceConfigsService.ConfigEnvironment.values.zipWithIndex) {
                        <div id="header-@{index + 1}" class="grid-item truncate-content column-@env.asString @if(!show(env)){hidden}" style="width:500px;">
                            <div>@env.displayString
                            @(configByKey.filter(_._2.get(env).exists(_.exists(_.nextDeployment))).size match {
                                case _ if env == ServiceConfigsService.ConfigEnvironment.Local => <span></span>
                                case 0 => <span></span>
                                case 1 => <span class="undeployed small-text"><span class="glyphicon glyphicon-exclamation-sign"></span> 1 undeployed change</span>
                                case x => <span class="undeployed small-text"><span class="glyphicon glyphicon-exclamation-sign"></span> {x} undeployed changes</span>
                            })
                            </div>
                            <div>@findDeployment(env).fold("")(_.versionNumber.asString)</div>
                        </div>
                        <div class="gutter gutter-horizontal column-@env.asString @if(!show(env)){hidden}"></div>
                    }
                </div>
                @for((key, envSources) <- configByKey.toSeq.sortBy(_._1.asString)) {
                    @defining(envSources.forall(_._2.map(_.source).forall(_ == "referenceConf"))) { isRefconfOnly =>
                        <div id="@{UrlUtils.encodeQueryParam(s"config-row-${key.asString}")}" class="grid-row @if(isRefconfOnly) {refconf-only}">
                            <div id="@{UrlUtils.encodeQueryParam(s"config-key-${key.asString}")}" class="grid-item sticky-column truncate-content" style="width:310px;">
                                <a id="@{UrlUtils.encodeQueryParam(s"config-url-${key.asString}")}" href="#@key.asString" class="glyphicon glyphicon-link"></a>
                                @key.asString
                                @if(uk.gov.hmrc.cataloguefrontend.CatalogueFrontendSwitches.showConfigSearch.isEnabled) {
                                    <a href="@{serviceConfigsRoutes.ServiceConfigsController.searchResults(configKey = Some(key.asString), configKeyIgnoreCase = Some(true), configValueIgnoreCase = Some(true)).url}" class="glyphicon glyphicon-search pull-right"></a>
                                }
                            </div>
                            @for(env <- ServiceConfigsService.ConfigEnvironment.values) {
                                <div class="grid-item column-@env.asString @if(!show(env)){hidden}" style="width:510px;">
                                    <ul>
                                      @for((sourceValue: ServiceConfigsService.ConfigSourceValue, idx) <- envSources.getOrElse(env, Seq.empty).zipWithIndex) {
                                        <li class="config-value" title="@ServiceConfigsService.friendlySourceName(sourceValue.source, env, Some(key))">
                                            @if(sourceValue.nextDeployment && sourceValue.value.trim.isEmpty) {
                                              <span class="truncate-content-overflow undeployed"><span class="glyphicon glyphicon-exclamation-sign small-text"></span> << Deleted >>  </span>
                                            } else if (sourceValue.nextDeployment) {
                                              <span class="truncate-content-overflow undeployed"><span class="glyphicon glyphicon-exclamation-sign small-text"></span> @sourceValue.value </span>
                                            } else {
                                              <span class="truncate-content-overflow
                                                           @if(sourceValue.isSuppressed) {suppressed}
                                                           @if(envSources.getOrElse(env, Seq.empty).filterNot(_.nextDeployment).size != idx+1) {strikethrough}
                                                           ">
                                                @sourceValue.value
                                              </span>
                                            }
                                            @sourceValue.sourceUrl.map { url =>
                                              <a class="glyphicon glyphicon-circle-arrow-right" target="raw" href="@url"></a>
                                            }
                                        </li>
                                      }
                                    </ul>
                                </div>
                            }
                        </div>
                        <script @CSPNonce.attr>
                          var elmt = document.getElementById("@{UrlUtils.encodeQueryParam(s"config-url-${key.asString}")}");
                          elmt.addEventListener("click", function() {
                            navigator.clipboard.writeText(elmt.href);
                          });
                        </script>
                    }
                }
            </div>
        </section>
        <aside id="menu">
            <h2>Columns</h2>
            <ul>
                @for(env <- ServiceConfigsService.ConfigEnvironment.values) {
                    <li>
                        <input class="column-filter" type="checkbox" id="show-@env.asString" @if(show(env)){checked="checked"} />
                        <label for="show-@env.asString">@env.asString</label>
                    </li>
                }
            </ul>
            <h2>Values</h2>
            <ul>
                <li>
                    <input type="checkbox" id="show-referenceConf" />
                    <label for="show-referenceConf">Show all reference.conf files</label>
                </li>
                <li>
                    <input type="checkbox" id="show-evictions" checked="checked" />
                    <label for="show-evictions">Show evictions</label>
                </li>
                <li>
                    <input type="checkbox" id="word-wrap" />
                    <label for="word-wrap">Word wrap</label>
                </li>
            </ul>
        </aside>
        <aside id="help">
            <h2>What am I seeing?</h2>
            <ul class="bullets">
                <li>Configuration is composed from multiple sources in a hierarchy of precedence. This table shows the end result and hierarchical eviction for each configuration key and for each environment. See <a id="link-to-confluence" href="https://confluence.tools.tax.service.gov.uk/display/DTRG/Service+configuration+explained" target="_blank">Confluence</a> for more details on how configuration is composed.</li>
                <li>Crossed out values indicate an eviction according to their precendence in the config hierarchy</li>
                <li>Amber values show what the value will change to when redeployed</li>
                <li>The Microservice <code>reference.conf</code> files and <code>application.conf</code> config are extracted from the build of the deployed slug. The version of the slug is shown under the environment.</li>
                <li>The App-config environment (<code>app-config-$env</code>), common configuration (<code>app-config-common</code>) and <code>app-config-base</code> are applied at deployment time by looking up the latest config from github. The config shown is the config that was applied at the deployment. Any changes to config since then that will be applied at the next deployment is also shown in amber. Note, we don't detect changes to encoded (ENC[...]) secrets.</li>
            </ul>
            <h2>How to use the config explorer</h2>
            <ul class="bullets">
                <li>Drag the handles to the left of column headers to re-size columns</li>
                <li>Hover over a key and click the <span class="glyphicon glyphicon-link"></span> icon to copy bookmark url to clipboard</li>
                <li>Hover over a config value to see it's source</li>
                <li>Triple click a truncated value to select the whole thing</li>
                <li>Click the <span class="glyphicon glyphicon-circle-arrow-right"></span> arrow to the right of a value to see the config item in context</li>
                <li>Toggle environments on/off and adjust formatting using the <span class="glyphicon glyphicon-menu-hamburger"></span> menu</li>
                <li>Toggle inclusion of values from reference.conf files using the <span class="glyphicon glyphicon-menu-hamburger"></span> menu icon. Note reference.conf values are always shown if they have been overridden</li>
                <li>Ctrl-f to search for a key or value (uses browser find)</li>
            </ul>
        </aside>
        <script @CSPNonce.attr type="text/javascript">
            ready(function() {
                (window.onhashchange = function () {
                    const el = document.getElementById(location.hash.replace("#", "config-row-"));
                    const highlighted = Array.from(document.getElementsByClassName("highlight-amber"));
                    highlighted.forEach(e => e.classList.remove("highlight-amber"));

                    if (el) {
                        el.scrollIntoView({block: "center", inline: "nearest", behavior: "smooth"});
                        el.classList.add("highlight-amber");
                    }
                })();

                Split(["#header-0", "#header-1", "#header-2", "#header-3", "#header-4", "#header-5", "#header-6", "#header-7"], {
                    sizes: [300, 500, 500, 500, 500, 500, 500, 500]
                });

                const body = document.querySelector("body");
                document.querySelector(".menu-icon").addEventListener("click", e => {
                    body.classList.remove("help-open");
                    body.classList.toggle("sidebar-open");
                });

                document.querySelectorAll(".help-icon").forEach(elmt => {
                    elmt.addEventListener("click", e => {
                        body.classList.remove("sidebar-open");
                        body.classList.toggle("help-open");
                    });
                });

                Array.from(document.querySelectorAll(".column-filter")).forEach(input => {
                    const env = input.id.replace("show-", "");
                    input.addEventListener("change", e => {
                        Array.from(document.getElementsByClassName(`column-${env}`)).forEach(item => {
                            item.classList.toggle("hidden");
                        });
                    });
                });

                document.querySelector("#show-evictions").addEventListener("change", e => {
                    Array.from(document.querySelectorAll(".strikethrough")).forEach(item => {
                        item.classList.toggle("hide-evictions")
                    });
                });
                document.querySelector("#show-referenceConf").addEventListener("change", e => {
                    document.querySelector("body").classList.toggle("hide-refconf-only");
                });
                document.querySelector("#word-wrap").addEventListener("change", e => {
                    document.querySelector("body").classList.toggle("word-wrap");
                });
            });
        </script>
    </body>
</html>
