@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.model.Environment
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import views.html.helper.select
@import views.html.partials.form_warnings
@import uk.gov.hmrc.cataloguefrontend.serviceconfigs.ServiceConfigsService
@import uk.gov.hmrc.cataloguefrontend.{ routes => appRoutes }
@import uk.gov.hmrc.cataloguefrontend.serviceconfigs.{ routes => serviceConfigsRoutes }

@this()

@(form    : Form[uk.gov.hmrc.cataloguefrontend.serviceconfigs.ConfigSearch],
  allKeys : Seq[String],
  allTeams: Seq[Team],
  results : Option[Map[ServiceConfigsService.KeyName, Map[ServiceConfigsService.ServiceName, Map[Environment, Option[String]]]]] = None
)(implicit
  messages: Messages,
  request : RequestHeader
)

@standard_layout("Search Config by Key") {
    <header>
        <h1>Search Config by Key</h1>
    </header>

    @form_warnings(form)

    <form id="form" method="GET">
        <div class="form-group">
            <div class="row">
                <div class="col-md-3">
                    @select(
                        field              = form("teamName"),
                        options            = allTeams.map(t => t.name.asString -> t.name.asString),
                        Symbol("_default") -> "All",
                        Symbol("_label")   -> "Team",
                        Symbol("id")       -> "team-filter",
                        Symbol("class")    -> "form-control"
                    )
                </div>
                <div class="col-md-7">
                    <dl>
                        <dt><label for="config-key">Config Key</label></dt>
                        <dd>
                            <input class="form-control" id="config-key" type="text" name="key" value='@form("key").value' autocomplete="off">
                            <div id="config-search-matches" class="search-matches-dropdown hide"></div>
                        </dd>
                    </dl>
                </div>
                <div class="col-md-2">
                    <dl>
                        <dt><label>Environments</label></dt>
                        <dd>
                            @for(env <-  Environment.values) {
                                <div>
                                    <input name="showEnviroments[]" id="@{env.asString}-checkbox" type="checkbox" value="@env.asString"
                                        @if(form.get.showEnviroments.contains(env)) {checked}> @env.displayString</input>
                                </div>
                            }
                        </dd>
                    </dl>
                </div>
            </div>
            <div><button id="config-search" class="btn btn-primary" type="submit">Search</button></div>
        </div>
    </form>

    <script @CSPNonce.attr src="@routes.Assets.versioned("search-with-autocomplete.js")"></script>
    <script @CSPNonce.attr>
        document
            .getElementById('team-filter')
            .addEventListener("change", () => document.getElementById("form").submit());

        let autoCompleteValues = [@for(key <- allKeys) { '@key', }];
        init("form", "config-key", "config-search-matches", autoCompleteValues);

        [@for(env <- Environment.values) { '@env.asString', }]
            .forEach(id => document.getElementById(`${id}-checkbox`).addEventListener("change", () => document.getElementById("form").submit()));
    </script>

    @results.map { res =>
        @if(res.isEmpty) {
            <p>No results found.</p>
        }

        @for((configKey, configByService) <- res) {
            <div>Results for <code>@configKey.asString</code></div>
            <table class="table table-striped always-wrap sticky-header" style="table-layout:fixed">
                <thead>
                    <tr>
                        <th>Service</th>
                        @for(env <- form.get.showEnviroments) {
                            <th id="@{env.asString}-tr">@env.displayString</th>
                        }
                    </tr>
                </thead>
                <tbody>
                @for((serviceName, configByEnv) <- configByService) {
                    <tr>
                        <td><a href="@appRoutes.CatalogueController.repository(serviceName.asString).url" title="Link to Service Page">@serviceName.asString</a></td>
                        @for(env <- form.get.showEnviroments) {
                            <td name="@{env.asString}-td">
                                @configByEnv.get(env).flatten.fold(Html("")) { configValue =>
                                    <a href="@serviceConfigsRoutes.ServiceConfigsController.configExplorer(serviceName.asString).url#@configKey.asString" title="Link to Config Explorer">
                                        @configValue
                                    </a>
                                }
                            </td>
                        }
                    </tr>
                }
                </tbody>
            </table>
        }
    }
}
