@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.Deployment
@import uk.gov.hmrc.cataloguefrontend.connector.Team
@import uk.gov.hmrc.cataloguefrontend.model.Environment
@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import helper._

@this()

@(
    selectedEnv: Environment, deployments: Seq[Deployment],
    teams: Seq[Team],
    userProfileBaseUrl: String,
    form: Form[_]
)(implicit messages: Messages, request: Request[_])

@standard_layout("Deployments", "deployments") {
    <header>
        <h1>Deployments: @selectedEnv.asString</h1>
    </header>

    <div id="service-list">
        <form method="get">
            <div class="form-group row">
            <span>Service: <input id="service-search-input" type="text" name="service" value='@form("service").value'></span>
             @select(
                 field = form("platform"),
                 options = Seq(
                     "Heritage" -> "Heritage",
                     "ECS" -> "ECS"
                 ),
                 '_default -> "All",
                 '_label -> "Platform",
                 'onchange -> "this.form.submit()",
                 'id -> "platform-search"
             )
             @select(
                 field = form("team"),
                 options = teams.map(t => t.name.asString -> t.name.asString),
                 '_default -> "All",
                 '_label -> "Team",
                 'onchange -> "this.form.submit()",
                 'id -> "team-search"
             )
         </div>

            <div class="form-group row">
            <div class="input-group">
                Date from: <input id="from-search-input" type="date" name="from" value='@form("from").value'>
                to:<input type="date" id="to-search-input" name="to" value='@form("to").value'>
            </div>

            <input type="submit" value="Filter">
        </div>
        </form>

        <div class="row">
            <ul id="environment" class="nav nav-tabs">
                @Environment.values.map(envOption)
            </ul>
        </div>

        <table class="table table-striped">
            <tr>
                <th class="col-lg-4"><button role="button" class="sort no-border" data-sort="service-name">Service</button></th>
                <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="team">Teams</button></th>
                <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="version">Version</button></th>
                <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="deploy-time">Deploy Time</button></th>
                <th class="col-lg-2"><button role="button" class="sort no-border" data-sort="deployer">Deployer</button></th>
            </tr>
            <tbody class="list">
                @deployments.zipWithIndex.map{case (d, i) =>
                <tr id="row@i">
                  <td id="row@{i}_name" class="service-name">
                      @if(d.isECS){ <span class="label label-primary pull-right">ECS</span>}
                      <a href="@{uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.service(d.name.asString).url}">@{d.name.asString}</a>
                  </td>
                  <td id="row@{i}_team" class="team">
                    <ul class="list-group">
                    @for(team <- d.teams) {
                      <li><a href="@{uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.team(team).url}">@{team.asString}</a></li>
                    }
                    </ul>
                  </td>
                  <td id="row@{i}_version"    class="version monospaced">@{d.version.asString}</td>
                  <td id="row@{i}_production" class="deploy-time monospaced">@{d.firstSeen.time.asString}</td>
                  <td id="row@{i}_deployer"   class="deployer monospaced">
                    @d.latestDeployer.map{u =><a href="@userProfileBaseUrl/@{u.userName}" target="_blank">@{u.userName}<span class="glyphicon glyphicon-new-window"/></a>}.getOrElse("N/A")
                  </td>
                </tr>
                }
          </tbody>
      </table>
    </div>
}

<!-- listjs configuration -->
<script>
var options = { valueNames: [ 'service-name','team', 'version', 'deploy-time', 'deployer' ] };
var serviceList = new List('service-list', options);
</script>

@envOption(env: Environment) = {
<li id="tab-@env.asString" class="navbar-item @if(env == selectedEnv){active}">
    <a href="@uk.gov.hmrc.cataloguefrontend.whatsrunningwhere.routes.DeploymentHistoryController.history(env)" class="navbar-link">@env.displayString</a>
</li>
}