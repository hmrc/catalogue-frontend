@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.{ViewMessages, routes => appRoutes }
@import uk.gov.hmrc.cataloguefrontend.DependencyExplorerController.PieData
@import uk.gov.hmrc.cataloguefrontend.connector.model.{BobbyVersionRange, DependencyScope, GroupArtefacts, ServiceWithDependency, TeamName}
@import uk.gov.hmrc.cataloguefrontend.model.SlugInfoFlag
@import uk.gov.hmrc.cataloguefrontend.DependencyExplorerController
@import views.html.partials.TeamNames

@this(
        teamNames: TeamNames,
        viewMessages: ViewMessages
)

@(form            : Form[_],
  teams           : Seq[TeamName],
  flags           : Seq[SlugInfoFlag],
  scopes          : Seq[DependencyScope],
  groupArtefacts  : List[GroupArtefacts],
  versionRange    : BobbyVersionRange,
  searchResults   : Option[Seq[ServiceWithDependency]],
  pieData         : Option[PieData]
)(implicit
  request         : RequestHeader,
  messagesProvider: MessagesProvider
)

@standard_layout("Dependency Explorer", "search") {
    <header>
        <h1 id="search-service-header">Dependency Explorer</h1>
        <script @CSPNonce.attr type="text/javascript" src="@controllers.routes.Assets.versioned("charts-loader-51.js")"></script>
    </header>

    <div id="service-list">

        @if(form.hasGlobalErrors) {
            <div class="alert alert-error error">
                <a class="close" data-dismiss="alert">Ã—</a>
                <ul>
                    @form.globalErrors.map { error =>
                        <li>@error.format</li>
                    }
                </ul>
            </div>
        }

        <form id="search-by-dependency-form" action="@appRoutes.DependencyExplorerController.search().url" method="get">
            <div class="form-group">
                <div class="row" style="margin-bottom: 20px;">
                    <div class="col-md-7">
                        <label for="group-artefact-search">Group:Artefact</label>
                        <input id="group-artefact-search" class="form-control" type="text" value="@DependencyExplorerController.groupArtefactFromForm(form)" autocomplete="off">
                        <div id="group-artefact-matches" class="dependency-search-dropdown hide" style="padding-right: 30px"></div>
                        <input id="group" name="group" value='@form("group").value' type="hidden">
                        <input id="artefact" name="artefact" value='@form("artefact").value' type="hidden">
                    </div>
                    <div class="col-md-5">
                        <label for="lbValue">Version Range</label>
                        <div class="input-group-multi">
                            <div class="col-xs-3 col-md-3">
                                <input class="form-control input-group-start" id="lbValue" type="text" placeholder="0.0.0" value="@versionRange.lowerBound.map(_.version)">
                            </div>
                            <div class="col-xs-2 col-md-2">
                                <select id="lbInclusive" class="form-control input-group-end">
                                    <option value="false" @if(versionRange.lowerBound.map(_.inclusive).getOrElse(false)) { selected }>&lt;</option>
                                    <option value="true" @if(versionRange.lowerBound.map(_.inclusive).getOrElse(true)) { selected }>&lt;=</option>
                                </select>
                            </div>
                            <div class="col-xs-2 col-md-2">
                                <input class="form-control undecorated-text" type="text" value="version" tabindex="-1" readonly>
                            </div>
                            <div class="col-xs-2 col-md-2">
                                <select id="ubInclusive" class="form-control input-group-start">
                                    <option value="false" @if(versionRange.upperBound.map(_.inclusive).getOrElse(false)) { selected }>&lt;</option>
                                    <option value="true" @if(versionRange.upperBound.map(_.inclusive).getOrElse(true)) { selected }>&lt;=</option>
                                </select>
                            </div>
                            <div class="col-xs-3 col-md-3">
                                <input class="form-control input-group-end" id="ubValue" type="text" value="@versionRange.upperBound.map(_.version)">
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="versionRange" name="versionRange" value="@form("versionRange").value">
                    <input type="hidden" id="asCsv" name="asCsv" value="false">
                </div>
                <div class="row">
                    <div class="col-md-3">
                        @helper.select(
                            field               = form("team"),
                            options             = teams.map(t => (t.asString, t.asString)),
                            Symbol("_default") -> "All teams",
                            Symbol("_label")   -> "Team",
                            Symbol("class")    -> "form-control"
                        )
                    </div>
                    <div class="col-md-2">
                        @helper.select(
                            field             = form("flag"),
                            options           = flags.map(f => (f.asString, f.displayString)),
                            Symbol("_label") -> "Flag",
                            Symbol("class")  -> "form-control"
                        )
                    </div>
                    <div class="col-md-2">
                        @helper.select(
                            field               = form("scope"),
                            options             = scopes.map(s => (s.asString, s.displayString)),
                            Symbol("_label")   -> "Scope",
                            Symbol("class")    -> "form-control",
                            Symbol("multiple") -> None
                        )
                    </div>
                </div>
                <div>
                    <button id="search-button" class="btn btn-primary" type="submit">Search</button>
                    <input type="button" id="export-button-1" class="btn btn-default" value="Export as CSV"/>
                </div>
            </div>
        </form>

        @searchResults match {
            case None                => {
                <ul class="list"/>
            }
            case Some(Nil)           => {
                <p id="search-results-empty">This search did not return any results.</p>
                <ul class="list"/>
            }
            case Some(searchResults) => {
                <p>Found @searchResults.size results</p>

                <div id="chart_div" align="center"></div>

                <table id="search-results" class="table table-striped">
                    <thead>
                        <tr>
                            <th rowspan="2"><button class="sort no-border" data-sort="service">Service</button></th>
                            <th rowspan="2">Version</th>
                            <th rowspan="2"><button class="sort no-border" data-sort="teams">Team</button></th>
                            <th colspan="4" class="text-center">Dependency</th>
                        </tr>
                        <tr>
                            <th>Group ID</th>
                            <th>Artefact ID</th>
                            <th><button class="sort no-border" data-sort="dep-version">Version</button></th>
                            <th>Scope</th>
                        </tr>
                    </thead>
                    <tbody class="list">
                        @for(result <- searchResults) {
                            <tr>
                                <td class="service"><a id="link-to-info-page-for-@{result.slugName}"href="@appRoutes.CatalogueController.service(result.slugName)">@result.slugName</a></td>
                                <td>@result.slugVersion</td>
                                <td class="teams">
                                    @teamNames(result.teams, s"${uk.gov.hmrc.cataloguefrontend.routes.CatalogueController.service(result.slugName)}#teams")
                                </td>
                                <td>@result.depGroup</td>
                                <td>@result.depArtefact</td>
                                <td class="dep-version">@result.depVersion</td>
                                <td>@result.scopes.map(_.displayString).mkString(", ")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }
    </div>

    <script @CSPNonce.attr>
        @if(searchResults.exists(_.nonEmpty)) {
          let options = { valueNames: [ 'service', 'teams', 'dep-version' ] };
          new List('service-list', options);
        }

        const allGroupArtefacts = [
            @for(ga <- groupArtefacts) {
                @for(artefact <- ga.artefacts) {
                    '@ga.group:@artefact',
                }
            }
        ]

        function exportAsCsv() {
            document.getElementById('asCsv').value = true;
            document.getElementById('search-by-dependency-form').submit();
            document.getElementById('asCsv').value = false;
        }

        document.getElementById("export-button-1").addEventListener("click", function() {
            exportAsCsv()
        });

        function updateGroupArtefact(groupArtefact) {
            let parts = groupArtefact.split(':');
            document.getElementById('group').value = parts[0];
            document.getElementById('artefact').value = parts[1];
        }

        function updateVersionRange() {
            const lbValue      = document.getElementById('lbValue').value;
            const lbInclusive  = document.getElementById('lbInclusive').value;
            const ubInclusive  = document.getElementById('ubInclusive').value;
            const ubValue      = document.getElementById('ubValue').value;

            let rangeStart = lbInclusive == 'true' ? '[' : '(';
            let rangeFrom  = lbValue ? lbValue : '0.0.0';
            let rangeEnd   = ubInclusive == 'true' ? ']' : ')';

            document.getElementById('versionRange').value = rangeStart + rangeFrom + ',' + ubValue + rangeEnd;
        }

        document.getElementById("search-by-dependency-form").addEventListener("submit", function() {
            updateVersionRange()
        });

        let gaSearch = document.getElementById('group-artefact-search');
        let matchesDiv = document.getElementById("group-artefact-matches")

        function clearMatches() {
            matchesDiv.innerHTML = '';
            matchesDiv.classList.add('hide');
        }

        function clearSearch() {
            gaSearch.value = '';
            document.getElementById('group').value = '';
            document.getElementById('artefact').value = '';
            clearMatches()
        }

        function highlightMatch(idx, toggle) {
            let match = document.getElementById('dependency-match-' + idx)
            if(match != null) {
                if(toggle) {
                    match.classList.add('dependency-match-selected');
                } else {
                    match.classList.remove('dependency-match-selected');
                }
            }
        }

        function matchesInBold(query, match) {
            let bolded = match;
            query.toLowerCase().split(' ').forEach(function (term) {
                bolded = bolded.toLowerCase().replaceAll(term, '<strong>' + term + '</strong>');
            });

            return bolded;
        }

        const minSearch = 3;
        let gaSelectedIdx = 0;
        let gaMatchesLen = 0;
        let gaScrollPos = 0;

        function gaSearchInputListener(e) {
            if(e.target.value.length >= minSearch) {
                if(e.keyCode > 46 || e.keyCode === 32 || e.keyCode === 8) { // alphanum, space and backspace
                    clearMatches();
                    groupArtefactSearch(e.target.value);
                } else if (e.keyCode === 13) { //enter
                    let selected = document.getElementById('dependency-match-' + gaSelectedIdx);
                    if(selected != null) {
                        selected.click();
                    } else {
                        updateVersionRange()
                        document.getElementById('search-by-dependency-form').submit();
                    }
                } else if (e.keyCode === 40) { //down arrow
                    if(gaSelectedIdx < gaMatchesLen - 1) {
                        highlightMatch(gaSelectedIdx, false);
                        gaSelectedIdx++;
                        highlightMatch(gaSelectedIdx, true);
                        updateScroll();
                    }
                } else if (e.keyCode === 38) { //up arrow
                    if(gaSelectedIdx > 0) {
                        highlightMatch(gaSelectedIdx, false);
                        gaSelectedIdx--;
                        highlightMatch(gaSelectedIdx, true);
                        updateScroll();
                    }
                }
            } else {
                matchesDiv.innerHTML = '';
                matchesDiv.classList.add('hide');
            }
        }

        function updateScroll() {
            if(gaSelectedIdx > 5) {
                const height = parseInt(window.getComputedStyle(document.getElementById('dependency-match-0')).height.replace('px', ''));
                matchesDiv.scrollTop = (gaSelectedIdx - 5) * height;
            } else {
                matchesDiv.scrollTop = 0;
            }
        }

        function gaDisableDefaults(e) {
            if(e.keyCode === 38 || e.keyCode === 40 || e.keyCode === 13) {
                e.preventDefault();
            }
        }

        function groupArtefactSearch(raw) {
            let query = raw.trim();
            let matches = [];

            let terms = query.split(' ');
            let first = terms.shift();

            matches = allGroupArtefacts.filter(function (el) {
                return el.toLowerCase().includes(first.toLowerCase());
            });

            if(terms.length > 0) {
                terms.forEach(function(term) {
                    matches = matches.filter(function (el) {
                        return el.toLowerCase().includes(term.toLowerCase());
                    });
                });
            }

            let matchesList = document.createElement('div')
            matchesList.classList.add('list-group', 'dependency-match-list');

            if(matches.length == 0) {
                let node = document.createElement('button');
                node.classList.add('list-group-item', 'disabled');
                node.innerHTML = 'No matches found'
                matchesList.appendChild(node);
            } else {
                let idx = 0
                gaMatchesLen = matches.length;
                matches.forEach(function (match) {
                    let btn = document.createElement('a');
                    btn.id = 'dependency-match-' + idx;
                    btn.classList.add('list-group-item');
                    btn.innerHTML = matchesInBold(query, match);
                    btn.onclick = function() {
                        clearMatches();
                        gaSearch.value = match;
                        updateGroupArtefact(match);
                    }
                    matchesList.appendChild(btn);
                    idx++;
                });
            }

            matchesDiv.appendChild(matchesList);
            gaSelectedIdx = 0;
            updateScroll();
            highlightMatch(gaSelectedIdx, true);
            matchesDiv.classList.remove('hide');
        }

        gaSearch.addEventListener('keyup', gaSearchInputListener, false);
        gaSearch.addEventListener('keydown', gaDisableDefaults, false);
    </script>

    <script @CSPNonce.attr type="text/javascript">
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {

            @pieData match {
                case None => {}
                case Some(pd) => {

                    var data = new google.visualization.DataTable();
                    var x =   Math.floor((Math.random() * 10) + 1);
                    data.addColumn('string', 'Version');
                    data.addColumn('number', 'Count');
                    data.addRows([
                        @for(r <- pd.results) {
                        ['@r._1', @r._2],
                        }
                    ]);

                    var options = { 'title'    : '@pd.title',
                                    'width'    : "80%",
                                    'height'   : 200,
                                    'chartArea': { 'width': '100%',
                                                'height': '100%'}};
                    var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
                    chart.draw(data, options);
                }
            }
        }
    </script>
}
