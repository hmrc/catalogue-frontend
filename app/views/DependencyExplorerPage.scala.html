@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.mvc.Call
@import uk.gov.hmrc.cataloguefrontend.connector.{SlugInfoFlag, Team}
@import uk.gov.hmrc.cataloguefrontend.connector.model.{BobbyVersionRange, GroupArtefacts, ServiceWithDependency, VersionOp}
@import uk.gov.hmrc.cataloguefrontend.DependencyExplorerController.PieData
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.routes
@import uk.gov.hmrc.cataloguefrontend.service.SearchByUrlService.FrontendRoutes
@import play.twirl.api.Html

@this(viewMessages: ViewMessages)

@(form            : Form[_],
  teams           : Seq[String],
  flags           : Seq[SlugInfoFlag],
  groupArtefacts  : List[GroupArtefacts],
  versionRange    : Option[BobbyVersionRange],
  searchResults   : Option[Seq[ServiceWithDependency]],
  pieData         : Option[PieData])(
  implicit request         : Request[_],
           messagesProvider: MessagesProvider)

@standard_layout("Dependency Explorer", "search") {
    <header>
        <h1 id="search-service-header">Dependency Explorer</h1>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </header>

    <div id="service-list">

        @if(form.hasGlobalErrors) {
            <div class="alert alert-error error">
                <a class="close" data-dismiss="alert">Ã—</a>
                <ul>
                    @form.globalErrors.map { error =>
                        <li>@error.format</li>
                    }
                </ul>
            </div>
        }

        <div class="board">
            <div class="board__body">
                @helper.form(
                    action =  routes.DependencyExplorerController.search,
                    'class -> "form-inline",
                    'id    -> "search-by-dependency-form") {
                    <table class="padded-table">
                        <tr>
                            <td style="vertical-align: top;">
                                @helper.select(
                                    form("group"),
                                    helper.options(Seq("" -> Messages("dependencyexplorer.select.group")) ++
                                                   groupArtefacts.map(_.group).map(g => (g, g)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                            <td style="vertical-align: top;">
                                @helper.select(
                                    form("artefact"),
                                    helper.options(List()),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                        </tr>
                    </table>
                    <table>
                        <tr>
                            <td style="vertical-align: top;">
                                @helper.inputText(
                                    form("version"),
                                    'id          -> "lbVersion",
                                    'size        -> 20,
                                    '_label      -> "",
                                    'placeholder -> "0.0.0",
                                    '_class      -> "form-group"
                                )
                            </td>
                            <td style="vertical-align: top;">
                                @helper.select(
                                    form("versionOp"),
                                    helper.options(List("<", "<=")),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                            <td style="vertical-align: bottom; padding-left: 10; padding-right: 10; ">version</td>
                            <td style="vertical-align: top;">
                                @helper.select(
                                    form("versionOp"),
                                    helper.options(List("<", "<=")),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                            <td style="vertical-align: top;">
                                @helper.inputText(
                                    form("version"),
                                    'id          -> "upVersion",
                                    'size        -> 20,
                                    '_label      -> "",
                                    'placeholder -> "99.99.99",
                                    '_class      -> "form-group"
                                )
                            </td>
                        </tr>
                    </table>
                    <table>
                        <tr>
                            <td>
                                @helper.select(
                                    form("team"),
                                    helper.options(Seq("" -> Messages("dependencyexplorer.select.teams.all")) ++
                                                   teams.map(t => (t, t)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                            <td>
                                @helper.select(
                                    form("flag"),
                                    helper.options(flags.map(t => (t.s, t.s.capitalize)) :_*),
                                    '_label -> "",
                                    '_class -> "form-group"
                                )
                            </td>
                            <input type="hidden" id="versionRange" name="versionRange" value="@form("versionRange").value">
                            <input type="hidden" id="asCsv" name="asCsv" value="false">
                            <td valign="bottom">
                                <button id="search-button" class="btn btn-primary" type="submit">Search</button>
                                <input type="button" id="export-button-1" class="btn btn-default" value="Export as CSV" onclick="exportAsCsv()"/>
                            </td>
                        </tr>
                        <tr>
                          <td colspan="5">
                            <h5>N.B. Dependencies are only applicable for Scala based services currently</h5>
                          </td>
                        </tr>
                        </table>
                     </div>
                }
                @searchResults match {
                    case None                => {}
                    case Some(Nil)           => {
                        <p id="search-results-empty">This search did not return any results.</p>
                    }
                    case Some(searchResults) => {
                        <p>Found @searchResults.size results @versionRange.flatMap(_.rangeDescr.map { case (lb, ub) => "for " + lb + " x " + ub }).getOrElse("") </p>

                        <div id="chart_div" align="center"></div>

                        <table id="search-results" class="table table-striped">
                            <thead>
                            <tr>
                                <th rowspan="2">Service</th>
                                <th rowspan="2">Version</th>
                                <th rowspan="2">Teams</th>
                                <th colspan="3" class="text-center">Dependency</th>
                            </tr>
                            <tr>
                                <th>Group ID</th>
                                <th>Artefact ID</th>
                                <th>Version</th>
                            </tr>
                            </thead>
                            <tbody class="list">
                            @for(result <- searchResults) {
                                <tr>
                                    <td><a href="@routes.CatalogueController.service(result.slugName)">@result.slugName</a></td>
                                    <td>@result.slugVersion</td>
                                    <td>@result.teams.mkString(", ")</td>
                                    <td>@result.depGroup</td>
                                    <td>@result.depArtefact</td>
                                    <td>@result.depVersion</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    }
                }
            </div>
        </div>
    </div>

    <script>
        if (document.readyState != 'loading'){
            ready();
        } else {
            document.addEventListener('DOMContentLoaded', ready);
        }

        function ready() {
            document.getElementById("group").onchange = updateArtefacts;
            updateArtefacts();
        }

        function updateArtefacts() {
            var group = document.getElementById("group").value;

            var groupArtefacts = {
                @groupArtefacts.map { res =>
                '@{res.group}': [@for(a <- res.artefacts){
                    '@a',
                    }]
                ,
                }
            }

            var artefactSelect = document.getElementById("artefact")
            while (artefactSelect.options.length > 0) {
                artefactSelect.remove(artefactSelect.options.length - 1);
            }

            var artefacts = groupArtefacts[group];
            if (artefacts) {
                var opt = document.createElement('option');
                opt.text = "@Messages("dependencyexplorer.select.artefact")";
                opt.value = "";
                artefactSelect.add(opt, null);
                for (i = 0; i < artefacts.length; i++)
                {
                    var opt = document.createElement('option');
                    opt.text = artefacts[i];
                    opt.value = artefacts[i];
                    opt.selected = artefacts[i] == '@{form("artefact").value}';
                    artefactSelect.add(opt, null);
                }
            }
        }

        function exportAsCsv() {
            document.getElementById('asCsv').value = true;
            document.getElementById('search-by-dependency-form').submit();
            document.getElementById('asCsv').value = false;
        }
    </script>

    <script type="text/javascript">
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {

            @pieData match {
                case None => {}
                case Some(pd) => {

                    var data = new google.visualization.DataTable();
                    var x =   Math.floor((Math.random() * 10) + 1);
                    data.addColumn('string', 'Version');
                    data.addColumn('number', 'Count');
                    data.addRows([
                        @for(r <- pd.results) {
                        ['@r._1', @r._2],
                        }
                    ]);

                    var options = { 'title'    : '@pd.title',
                                    'width'    : "80%",
                                    'height'   : 200,
                                    'chartArea': { 'width': '100%',
                                                'height': '100%'}};
                    var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
                    chart.draw(data, options);
                }
            }
        }
    </script>
}
