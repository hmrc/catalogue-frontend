@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.GitRepository
@import uk.gov.hmrc.cataloguefrontend.createawebhook.WebhookEventType
@import views.html.partials.{form_global_errors, form_fields_warnings}
@import views.html.helper.select

@this(viewMessages: ViewMessages)

@(
 form: Form[_],
 repositories: Seq[GitRepository],
)(implicit
 messages: Messages,
 request: RequestHeader
)

@isEventTypeChecked(formData: Map[String, String], webhookEventType: WebhookEventType) = @{
    val isSelected = formData.collect{ case (k, v) if k.startsWith("events") => v}
        .exists(event => WebhookEventType
                        .parse(event)
                        .map(_ == webhookEventType)
                        .getOrElse(false)
        )
    if (isSelected)
        "checked"
    else
        ""
}

@standard_layout("Create a Webhook", "create a webhook") {

    <section class="section-wrapper">
        <h1 class="page-heading mt-4">Create A Webhook</h1>
        <p>Use the below form to create a new webhook. Make sure to follow the guidance for each field!</p>

        @form_global_errors(form)

        @helper.form(
            action           =  uk.gov.hmrc.cataloguefrontend.createawebhook.routes.CreateAWebhookController.createAWebhook(),
            Symbol("id")     -> "create-webhook-form",
            Symbol("method") -> "post",
        ) {
            @csrfFormField
            <div class="form-group mb-2">
                <div class="row d-grid gap-2">
                    <label class="fw-bold" for="repository-name">Repository name:</label>
                    <div class="mb-2">
                        <div class="mb-2">
                            The repository to create the webhook in
                        </div>
                        <input class="form-control" type="text" id="repository-name" name="repositoryName" value='@form.data.getOrElse("repositoryName", "")' autocomplete="off">
                        <div id="repository-name-matches" class="search-matches-dropdown d-none"></div>
                    </div>
                    @form_fields_warnings(form,"repositoryName")
                </div>
                <div class="row d-grid gap-2">
                    <label class="fw-bold" for="webhook-url">Webhook Url:</label>
                    <div class="mb-2">
                        <div class="mb-2">
                            Url for the notification.
                        </div>
                        <input class="form-control" type="text" id="webhook-url" name="webhookUrl" value='@form.data.getOrElse("webhookUrl", "")'>
                    </div>
                    @form_fields_warnings(form,"webhookUrl")
                </div>
                <div class="row d-grid gap-2">
                    <label class="fw-bold" for="events">Events:</label>
                    <div class="ps-2 d-grid gap-2">
                    @WebhookEventType.values.map{ webhookEventType =>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="events[]" id="event-@{webhookEventType.value}" value=@webhookEventType.value @isEventTypeChecked(form.data, webhookEventType)>
                            <label class="form-check-label" for="event-@{webhookEventType.value}">@webhookEventType.asString</label>
                        </div>
                    }
                    </div>
                    @form_fields_warnings(form,"events")
                </div>
            </div>
            <div>
                <button id="create-webhook-submission-button" class="btn btn-success" type="submit">Create</button>
            </div>
       }
    </section>

    <script @CSPNonce.attr src="@routes.Assets.versioned("search-with-autocomplete.js")"></script>
  <script @CSPNonce.attr>
    autoCompleteInit({
      formId           : "create-webhook-form",
      inputSearchId    : "repository-name",
      matchesDivId     : "repository-name-matches",
      allowPartial     : false,
      ignoreCase       : true,
      submitOnSelection: false,
      values           : [@for(repository <- repositories) {'@repository.name',}]
    });
  </script>
}
