@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.model.Environment
@import uk.gov.hmrc.cataloguefrontend.shuttering.{ShutterEventsView, ShutterStateChangeEvent}

@(
  services    : Seq[String],
  events      : Seq[ShutterStateChangeEvent],
  form        : Form[_],
  environments: List[Environment]
)(implicit
  request : Request[_]
)

@standard_layout("Shutter Events", "shuttering") {
  <header>
    <h1>Shutter Events</h1>
  </header>

  <div id="events">

    <form id="shutter-events-form" action="/shutter-events/list" method="get">

      <datalist id="servicenames">
          @services.map { s: String => <option>@s</option> }
      </datalist>

      <input id="environment" name="environment" type="text" value="@form("environment").value" hidden>

      <div class="form-group row">
        <div class="col-md-1">
          <label for="serviceName">Service:</label>
        </div>
        <div class="col-md-4">
          <input class="search form-control" id="serviceName" name="serviceName" type="search" autofocus  autocomplete="off" list="servicenames"  value=@form("serviceName").value>
        </div>
        <div class="col-md-3">
          <a id="clear" class="btn btn-secondary" href="@clearTargetFor(environments.find(env => form("environment").value.contains(env.asString)).getOrElse(environments.head))">Clear</a>
          <button id="search-button" class="btn btn-primary" type="submit">Search</button>
        </div>
      </div>
    </form>

    <ul id="environmentTabs" class="nav nav-tabs" role="tablist">
      @environments.map(makeTab)
    </ul>

    <table class="table table-striped shutter-events" id="events-list">
      <thead>
        <tr>
          <th class="service">
            <button role="button" class="sort no-border" data-sort="service">Service</button>
          </th>
          <th class="type">
            <button role="button" class="sort no-border" data-sort="type">Type</button>
          </th>
          <th class="status">
            <button role="button" class="sort no-border" data-sort="status">Status</button>
          </th>
          <th class="reason">
            <button role="button" class="sort no-border" data-sort="reason">Reason</button>
          </th>
          <th class="cause">
            <button role="button" class="sort no-border" data-sort="cause">Cause</button>
          </th>
          <th class="username">
            <button role="button" class="sort no-border" data-sort="username">Username</button>
          </th>
          <th class="timestamp">
            <button role="button" class="sort no-border" data-sort="timestamp">Timestamp</button>
          </th>
        </tr>
      </thead>
      <tbody class="list">
        @events.zipWithIndex.map { case (event, i) =>
          <tr id="row@i">
             <td class="service" id="row@{i}_service">@event.serviceName</td>
             <td class="type" id="row@{i}_type">@event.shutterType.asString</td>
             <td class="status" id="row@{i}_status">@event.status.value.asString</td>
             <td class="reason" id="row@{i}_reason">@ShutterEventsView.reasonFor(event.status)</td>
             <td class="cause" id="row@{i}_cause">@event.cause.asString</td>
             <td class="username" id="row@{i}_username">@event.username</td>
             <td class="timestamp" id="row@{i}_timestamp">@event.timestamp.asPattern(`yyyy-MM-dd HH:mm:ss z`)</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
}

@makeTab(env: Environment) = {
  <li id="tab-@env.asString" class="nav-item @if(form("environment").value.contains(env.asString)) {active}">
    <a href="@uk.gov.hmrc.cataloguefrontend.shuttering.routes.ShutterEventsController.shutterEventsList(env, form("serviceName").value)" class="nav-link">@env.displayString</a>
  </li>
}

@clearTargetFor(env: Environment) = {
  @uk.gov.hmrc.cataloguefrontend.shuttering.routes.ShutterEventsController.shutterEventsList(env, None)
}

<script>
  let options = {
      valueNames: ['service', 'status', 'reason', 'cause', 'username', 'timestamp'],
      searchDelay: 350,
      indexAsync: true
  };

  let eventsList = new List('events', options);

  // force search after picking an auto-complete option
  var searchbox = document.getElementById("serviceName")
  searchbox.onblur = e => {
      eventsList.search(searchbox.value, ['service'])
  }

</script>
