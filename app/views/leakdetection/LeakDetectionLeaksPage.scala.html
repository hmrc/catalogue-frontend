@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.leakdetection.LeakDetectionLeaksByRule
@import uk.gov.hmrc.cataloguefrontend.leakdetection.LeakDetectionWarning
@import uk.gov.hmrc.cataloguefrontend.leakdetection.LeakDetectionReport
@import uk.gov.hmrc.cataloguefrontend.leakdetection.{routes => appRoutes}

@this(viewMessages: ViewMessages)

@(report           : LeakDetectionReport,
  exemptions       : Map[String, Int],
  unresolvedLeaks  : Seq[LeakDetectionLeaksByRule],
  warnings         : Seq[LeakDetectionWarning],
  leakResolutionUrl: String,
  isAuthorised     : Boolean
)(implicit
  request          : RequestHeader
)

@standard_layout(s"Leak detection report") {
    <header>
        <h1>Leak Detection Report</h1>
    </header>

  <div class="row row-cols-2">
      <div class="col-xs-6">
    <ul class="list list--minimal list-group row">
        <li class="col-xs-12">
            <label>Repository:</label>
            @report.repoName
        </li>
        <li class="col-xs-12">
            <label>Branch: </label>
            @report.branch
        </li>
        <li class="col-xs-12">
            <label>Scanned at: </label>
            @report.timestamp.displayFormat
        </li>
        <li class="col-xs-12">
            <label>Commit id: </label>
            @report.commitId
        </li>
        <li class="col-xs-12">
            <label>Author: </label>
            @report.author
        </li>
    </ul>
      </div>
      <div class="col-xs-6">
      @if(exemptions.nonEmpty || report.unusedExemptions.nonEmpty) {
          <h3>Exemptions</h3>
          <table class="table table-striped sticky-header">
              <thead>
                  <tr>
                      <th class="col-xs-10">Rule</th>
                      <th class="col-xs-2">Exemptions</th>
                  </tr>
              </thead>
              <tbody>
              @exemptions.map { l =>
                  <tr>
                      <td class="exemptRule">@l._1</td>
                      <td class="exemptCount text-center"><a href="@appRoutes.LeakDetectionController.reportExemptions(report.repoName, report.branch)">@l._2</a></td>
                  </tr>
              }
              @if(report.unusedExemptions.nonEmpty) {
                  <tr>
                      <td class="exemptRule">Unused exemptions</td>
                      <td class="exemptCount text-center"><a href="@appRoutes.LeakDetectionController.reportExemptions(report.repoName, report.branch)">@report.unusedExemptions.length</a></td>
                  </tr>
              }
              </tbody>
          </table>
      }
      </div>
  </div>

    @warnings.map {warning =>
        <div class="alert alert-danger">@warning.message</div>
    }

    @if(unresolvedLeaks.isEmpty) {
        <div class="alert alert-success">
            There are no unresolved leaks associated to this branch
        </div>
    } else {
        <h2>Unresolved leaks</h2>
        @if(isAuthorised) {
            <div class="alert alert-warning">
                Please click <a href="@leakResolutionUrl">here</a> to find out how to resolve the leaks
            </div>
            @LeakDetectionLeaks(unresolvedLeaks, "Violations")
        } else {
            <div class="alert alert-danger">
                Only members of an owning team can view the unresolved leak details as they may contain sensitive data
            </div>
        }
    }
}
