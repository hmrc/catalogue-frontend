@*
* Copyright 2022 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@
@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.Rule
@import uk.gov.hmrc.cataloguefrontend.service.RuleSummary

@this(viewMessages: ViewMessages)

@(ruleSummaries: Seq[RuleSummary])(implicit request: Request[_])

@standard_layout(s"Leak detection rules") {
    <header>
        <h1>Leak Detection Rules</h1>
    </header>

    @if(ruleSummaries.nonEmpty) {
        <table id="rule-list" class="rule-list table table-striped">
            <thead>
                <tr>
                    <th class="col-xs-2">Rule id</th>
                    <th class="col-xs-4">Description</th>
                    <th class="col-xs-2">Earliest violation</th>
                    <th class="col-xs-2">Latest violation</th>
                    <th class="col-xs-1">Violating repositories</th>
                    <th class="col-xs-1">Total violations</th>
                </tr>
            </thead>
            <tbody>
            @ruleSummaries.map(leakDetectionRuleSummary)
            </tbody>
        </table>
    }
}

@leakDetectionRuleSummary(ruleSummary: RuleSummary) = {
    <tr id="@ruleSummary.rule.id" class="hand-pointer collapsed" data-toggle="collapse" data-target="#collapsible-area-@ruleSummary.rule.id" aria-expanded="false" aria-controls="collapsible-area">
        <td class="rule-id">@ruleSummary.rule.id</td>
        <td class="description">@ruleSummary.rule.description</td>
        <td class="earliest-scanned">@if(ruleSummary.earliestScannedAt.nonEmpty) {
            @ruleSummary.earliestScannedAt.get.displayFormat
        } </td>
        <td class="latest-scanned">@if(ruleSummary.latestScannedAt.nonEmpty) {
            @ruleSummary.latestScannedAt.get.displayFormat
        } </td>
        <td class="repo-count">@ruleSummary.repoCount</td>
        <td class="total-count">@ruleSummary.totalCount</td>
    </tr>
    <tr id="blank-row-@ruleSummary.rule.id" class="hide" colspan="6"></tr>
    <tr id="collapsible-area-@ruleSummary.rule.id" class="collapse">
        <td colspan="6">
            <div class="board__body">
            @ruleDetails(ruleSummary.rule)
            </div>
        </td>
    </tr>
}

@ruleDetails(rule: Rule) = {
    <div class="row">
        <div class="col-md-12">
            <ul class="list list--minimal list-group row">
                <li id="rule-id" class="col-xs-6">
                    <label>Rule id: </label>
                    @rule.id
                </li>
                <li id="description" class="col-xs-6">
                    <label>Description: </label>
                    @rule.description
                </li>
                <li id="scope" class="col-xs-6">
                    <label>Scope: </label>
                    @rule.scope
                </li>
                <li id="priority" class="col-xs-6">
                    <label>Priority: </label>
                    @rule.priority
                </li>
                <li id="regex" class="col-xs-12">
                    <label>Regex: </label>
                    @rule.regex
                </li>
                @if(rule.ignoredFiles.nonEmpty) {
                    <li id="ignore-files" class="col-xs-6">
                        <label>Ignored files: </label>
                        <ul class="list list--minimal list-group row">
                        @rule.ignoredFiles.map { fileName =>
                            <li id="ignore-file-@fileName">@fileName</li>
                        }
                        </ul>
                    </li>
                }
                @if(rule.ignoredExtensions.nonEmpty) {
                    <li id="ignore-extensions" class="col-xs-6">
                        <label>Ignored extensions: </label>
                        <ul class="list list--minimal list-group row">
                        @rule.ignoredExtensions.map { fileExt =>
                            <li id="ignore-file-ext-@fileExt" class="col-xs-3">@fileExt</li>
                        }
                        </ul>
                    </li>
                }
            </ul>
        </div>
    </div>
}