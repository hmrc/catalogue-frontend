@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.cataloguefrontend.DateHelper._
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.connector.LeakDetectionRule
@import uk.gov.hmrc.cataloguefrontend.service.LeakDetectionRulesWithCounts

@this(viewMessages: ViewMessages)

@(ruleSummaries: Seq[LeakDetectionRulesWithCounts])(implicit request: Request[_])

    @standard_layout(s"Leak detection rules") {
        <header>
            <h1>Leak Detection Rules</h1>
        </header>

        @if(ruleSummaries.nonEmpty) {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th class="col-xs-1">Rule id</th>
                        <th class="col-xs-3">Description</th>
                        <th class="col-xs-3">Earliest violation</th>
                        <th class="col-xs-3">Latest violation</th>
                        <th class="col-xs-1" style="text-align: center">Violating repositories</th>
                        <th class="col-xs-1" style="text-align: center">Total violations</th>
                    </tr>
                </thead>
                <tbody>
                @ruleSummaries.map(leakDetectionRuleSummary)
                </tbody>
            </table>
        }
    }

    @leakDetectionRuleSummary(ruleSummary: LeakDetectionRulesWithCounts) = {
        <tr id="@ruleSummary.rule.id" >
            <td class="accordion-toggle collapsed hand-pointer " data-toggle="collapse" data-target="#collapsible-area-@ruleSummary.rule.id" />
            <td class="hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@ruleSummary.rule.id">@ruleSummary.rule.id</td>
            <td class="hand-pointer" data-toggle="collapse" data-target="#collapsible-area-@ruleSummary.rule.id">@ruleSummary.rule.description</td>
            <td>@if(ruleSummary.firstScannedAt.nonEmpty) {
                @ruleSummary.firstScannedAt.get.displayFormat
            } </td>
            <td>@if(ruleSummary.lastScannedAt.nonEmpty) {
                @ruleSummary.lastScannedAt.get.displayFormat
            } </td>
            <td style="text-align: center">@ruleSummary.repoCount</td>
            <td style="text-align: center">
            @if(ruleSummary.totalCount > 0) {
                <a href="/leak-detection/repositories?rule=@ruleSummary.rule.id">@ruleSummary.totalCount</a>
            } else {
                <span>0</span>
            }</td>
        </tr>
        <tr class="hide" />
        <tr id="collapsible-area-@ruleSummary.rule.id" class="collapse">
            <td colspan="7">
            @ruleDetails(ruleSummary.rule)
            </td>
        </tr>
    }

    @ruleDetails(rule: LeakDetectionRule) = {
        <div class="row">
            <div class="col-xs-12">
                <ul class="list list--minimal list-group row">
                    <li class="col-xs-6">
                        <label>Rule id: </label>
                        @rule.id
                    </li>
                    <li class="col-xs-6">
                        <label>Description: </label>
                        @rule.description
                    </li>
                    <li class="col-xs-6">
                        <label>Scope: </label>
                        @rule.scope
                    </li>
                    <li class="col-xs-6">
                        <label>Priority: </label>
                        @rule.priority
                    </li>
                    <li class="col-xs-12">
                        <label>Regex: </label>
                        @rule.regex
                    </li>
                    @if(rule.ignoredFiles.nonEmpty) {
                        <li class="col-xs-6">
                            <label>Ignored files: </label>
                            <ul class="list list--minimal list-group row">
                            @rule.ignoredFiles.map { fileName =>
                                <li>@fileName</li>
                            }
                            </ul>
                        </li>
                    }
                    @if(rule.ignoredExtensions.nonEmpty) {
                        <li class="col-xs-6">
                            <label>Ignored extensions: </label>
                            <ul class="list list--minimal list-group row">
                            @rule.ignoredExtensions.map { fileExt =>
                                <li class="col-xs-3">@fileExt</li>
                            }
                            </ul>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }